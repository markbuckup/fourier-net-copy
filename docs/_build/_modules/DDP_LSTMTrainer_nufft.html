<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DDP_LSTMTrainer_nufft &#8212; FOURIER-Net 20240614 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=6ad00ebc"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>FOURIER-Net 20240614 documentation</span></a></h1>
        <h2 class="heading"><span>DDP_LSTMTrainer_nufft</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for DDP_LSTMTrainer_nufft</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">kornia</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.distributed</span> <span class="kn">import</span> <span class="n">DistributedSampler</span>

<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-10</span>
<span class="n">CEPS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">EPS</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">EPS</span><span class="p">))</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils.functions</span> <span class="kn">import</span> <span class="n">fetch_loss_function</span>
<span class="kn">from</span> <span class="nn">utils.models.periodLSTM</span> <span class="kn">import</span> <span class="n">gaussian_2d</span><span class="p">,</span> <span class="n">mylog</span>

<div class="viewcode-block" id="myimshow">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.myimshow">[docs]</a>
<span class="k">def</span> <span class="nf">myimshow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">trim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays an image with optional trimming.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    x (np.ndarray): Image array to be displayed.</span>
<span class="sd">    cmap (str): Colormap used for display. Default is &#39;gray&#39;.</span>
<span class="sd">    trim (bool): Whether to trim the image intensities at 5th and 95th percentiles. Default is False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">trim</span><span class="p">:</span>
        <span class="n">percentile_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
        <span class="n">percentile_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">percentile_95</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentile_95</span>
        <span class="n">x</span><span class="p">[</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">percentile_5</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentile_5</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">)</span></div>


<div class="viewcode-block" id="special_trim">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.special_trim">[docs]</a>
<span class="k">def</span> <span class="nf">special_trim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">95</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trims the values of a tensor to be within the specified percentiles.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    x (torch.Tensor): Tensor to be trimmed.</span>
<span class="sd">    l (int): Lower percentile for trimming. Default is 5.</span>
<span class="sd">    u (int): Upper percentile for trimming. Default is 95.</span>

<span class="sd">    Returns:</span>
<span class="sd">    torch.Tensor: Trimmed tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">percentile_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">percentile_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">percentile_5</span><span class="p">,</span> <span class="n">percentile_95</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="torch_trim">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.torch_trim">[docs]</a>
<span class="k">def</span> <span class="nf">torch_trim</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes and trims a 4D tensor along its last two dimensions.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    x (torch.Tensor): Input tensor of shape (B, C, H, W).</span>

<span class="sd">    Returns:</span>
<span class="sd">    torch.Tensor: Normalized and trimmed tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">row</span><span class="o">*</span><span class="n">col</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="n">percentile_95</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">.95</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">percentile_5</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">.05</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">percentile_5</span>
        <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">percentile_5</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">percentile_95</span>
        <span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">percentile_95</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_difference_image">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.show_difference_image">[docs]</a>
<span class="k">def</span> <span class="nf">show_difference_image</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">im2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Displays the absolute difference between two images.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    im1 (np.ndarray): First image array.</span>
<span class="sd">    im2 (np.ndarray): Second image array.</span>

<span class="sd">    Returns:</span>
<span class="sd">    np.ndarray: Absolute difference image reshaped to a 1D array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">im1</span><span class="o">-</span><span class="n">im2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Trainer">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer">[docs]</a>
<span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trainer class for handling the training and evaluation of models in a distributed setup.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    recurrent_model (nn.Module): The recurrent module consisting of the k-space RNN and the image lstm.</span>
<span class="sd">    coil_combine_unet (nn.Module): The UNet model for combining coils.</span>
<span class="sd">    trainset (Dataset): Training dataset.</span>
<span class="sd">    testset (Dataset): Testing dataset.</span>
<span class="sd">    ispace_trainset (Dataset): Training dataset that can memoise the recurrent module prediction for a fast Unet training.</span>
<span class="sd">    ispace_testset (Dataset): Testing dataset that can memoise the recurrent module prediction for a fast Unet training</span>
<span class="sd">    parameters (dict): Dictionary of training parameters loaded from params.py</span>
<span class="sd">    device (torch.device): Device on which the training is conducted.</span>
<span class="sd">    ddp_rank (int): Rank of the current process in distributed training.</span>
<span class="sd">    ddp_world_size (int): Total number of processes in distributed training.</span>
<span class="sd">    args (Namespace): argparse arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurrent_model</span><span class="p">,</span> <span class="n">coil_combine_unet</span><span class="p">,</span> <span class="n">ispace_trainset</span><span class="p">,</span> <span class="n">ispace_testset</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">testset</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">ddp_rank</span><span class="p">,</span> <span class="n">ddp_world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Trainer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span> <span class="o">=</span> <span class="n">recurrent_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span> <span class="o">=</span> <span class="n">coil_combine_unet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span> <span class="o">=</span> <span class="n">ispace_trainset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ispace_testset</span> <span class="o">=</span> <span class="n">ispace_testset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span> <span class="o">=</span> <span class="n">trainset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testset</span> <span class="o">=</span> <span class="n">testset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span> <span class="o">=</span> <span class="n">ddp_rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span> <span class="o">=</span> <span class="n">ddp_world_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">):]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;save_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">temp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span> 
                                    <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span><span class="p">,</span> 
                                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span><span class="p">,</span> 
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
                                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ispace_trainset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispace_train_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span><span class="p">,</span> 
                                    <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span><span class="p">,</span> 
                                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span><span class="p">,</span> 
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
                                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispace_test_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">ispace_testset</span><span class="p">,</span> 
                                    <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span><span class="p">,</span> 
                                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span><span class="p">,</span> 
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
                                <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_test_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span> 
                                    <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span><span class="p">,</span> 
                                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span><span class="p">,</span> 
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
                                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_sampler</span> <span class="o">=</span> <span class="n">DistributedSampler</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">testset</span><span class="p">,</span> 
                                    <span class="n">num_replicas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_world_size</span><span class="p">,</span> 
                                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span><span class="p">,</span> 
                                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
                                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">],</span> 
                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">num_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dataloader_num_workers&#39;</span><span class="p">],</span>
                                <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_sampler</span>
                            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ispace_trainset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;train_batch_size&#39;</span><span class="p">],</span>
                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_train_sampler</span>
                            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispacetestloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">ispace_testset</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;test_batch_size&#39;</span><span class="p">],</span>
                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_test_sampler</span>
                            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traintestloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;test_batch_size&#39;</span><span class="p">],</span> 
                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">num_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dataloader_num_workers&#39;</span><span class="p">],</span>
                                <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_test_sampler</span>
                            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">testset</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;test_batch_size&#39;</span><span class="p">],</span> 
                                <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">num_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dataloader_num_workers&#39;</span><span class="p">],</span>
                                <span class="n">pin_memory</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">drop_last</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">sampler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_sampler</span>
                            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Adam&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">kspace_m</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ispacem</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lr_kspace&#39;</span><span class="p">],</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">kspace_m</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lr_kspace&#39;</span><span class="p">],</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lr_ispace&#39;</span><span class="p">],</span> <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler_params&#39;</span><span class="p">][</span><span class="s1">&#39;cycle_momentum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;StepLR&#39;</span><span class="p">:</span>
            <span class="n">mydic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler_params&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">],</span> <span class="n">gamma</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CyclicLR&#39;</span><span class="p">:</span>
            <span class="n">mydic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler_params&#39;</span><span class="p">]</span>
            <span class="n">ispace_mydic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;unet_scheduler_params&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">CyclicLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;base_lr&#39;</span><span class="p">],</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;max_lr&#39;</span><span class="p">],</span> <span class="n">step_size_up</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size_up&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">cycle_momentum</span> <span class="o">=</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;cycle_momentum&#39;</span><span class="p">],</span>  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">CyclicLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="p">,</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;base_lr&#39;</span><span class="p">],</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;max_lr&#39;</span><span class="p">],</span> <span class="n">step_size_up</span><span class="o">=</span><span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;step_size_up&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">cycle_momentum</span> <span class="o">=</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;cycle_momentum&#39;</span><span class="p">],</span>  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">CyclicLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="p">,</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;base_lr&#39;</span><span class="p">],</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;max_lr&#39;</span><span class="p">],</span> <span class="n">step_size_up</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;step_size_up&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">cycle_momentum</span> <span class="o">=</span> <span class="n">mydic</span><span class="p">[</span><span class="s1">&#39;cycle_momentum&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">CyclicLR</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="p">,</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;base_lr&#39;</span><span class="p">],</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;max_lr&#39;</span><span class="p">],</span> <span class="n">step_size_up</span><span class="o">=</span><span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;step_size_up&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span> <span class="n">cycle_momentum</span> <span class="o">=</span> <span class="n">ispace_mydic</span><span class="p">[</span><span class="s1">&#39;cycle_momentum&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l1loss</span> <span class="o">=</span> <span class="n">fetch_loss_function</span><span class="p">(</span><span class="s1">&#39;L1&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2loss</span> <span class="o">=</span> <span class="n">fetch_loss_function</span><span class="p">(</span><span class="s1">&#39;L2&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;loss_params&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span> <span class="o">=</span> <span class="n">kornia</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msssim_loss</span> <span class="o">=</span> <span class="n">kornia</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SSIMLoss</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<div class="viewcode-block" id="Trainer.train">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">print_loss</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>  <span class="c1"># AERS: Trains the epoch it is training for. print_loss is always False, so if it is True, something is wrong!</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trains the model for one epoch.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">        print_loss (bool): Whether to print the loss values. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        tuple: Averaged losses and scores for the epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># AERS: Determines if it is in k-space or image space mode: what model is training?</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">avgkspacelossphase</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossreal</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossforget_gate</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossinput_gate</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossmag</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">kspacessim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspace_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspace_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispacelossreal</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">sosssim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgsos_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgsos_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ispacessim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispace_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispace_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span>
            <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span>
            <span class="n">kspace_skip_frames_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span>
            <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span>
            <span class="n">kspace_skip_frames_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">),</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] | KS+IS Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> | </span><span class="si">{percentage:3.0f}</span><span class="s2">%|</span><span class="si">{bar:10}{r_bar}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">:</span>
                <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span><span class="p">),</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] | IS Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> | </span><span class="si">{percentage:3.0f}</span><span class="s2">%|</span><span class="si">{bar:10}{r_bar}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">),</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] | KS Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> | </span><span class="si">{percentage:3.0f}</span><span class="s2">%|</span><span class="si">{bar:10}{r_bar}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                <span class="n">tqdm_object</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ispacetrainloader</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tqdm_object</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainloader</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_instance</span> <span class="ow">in</span> <span class="n">tqdm_object</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_instance</span>
                <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mem</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">predr</span><span class="p">,</span> <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_kspace</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">undersampled_fts</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">og_coiled_vids</span> <span class="o">=</span> <span class="n">coilwise_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">og_coiled_fts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">inpt_mag_log</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">og_coiled_fts</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                    <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">og_coiled_fts</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">inpt_mag_log</span><span class="p">)</span>
                    <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">inpt_phase</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">inpt_phase</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                        <span class="n">predr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">loss_mag</span><span class="p">,</span> <span class="n">loss_phase</span><span class="p">,</span> <span class="n">loss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_l1</span><span class="p">,</span> <span class="n">loss_l2</span><span class="p">,</span> <span class="n">ss1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">periods</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">targ_phase</span> <span class="o">=</span> <span class="n">inpt_phase</span><span class="p">,</span> <span class="n">targ_mag_log</span> <span class="o">=</span> <span class="n">inpt_mag_log</span><span class="p">,</span> <span class="n">targ_real</span> <span class="o">=</span> <span class="n">og_coiled_vids</span><span class="p">,</span> <span class="n">og_video</span> <span class="o">=</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="p">)</span>

                        <span class="n">predr_sos</span> <span class="o">=</span> <span class="p">((</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>
                        <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">og_video</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>
                        <span class="n">loss_ss1_sos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msssim_loss</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                         
                        <span class="k">del</span> <span class="n">masks</span>
                        <span class="k">del</span> <span class="n">inpt_phase</span>
                        <span class="k">del</span> <span class="n">inpt_mag_log</span>
                        
                        
                        <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">loss_mag</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">loss_phase</span> <span class="o">+</span> <span class="mi">12</span><span class="o">*</span><span class="n">loss_real</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">loss_ss1_sos</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lstm_forget_gate_loss&#39;</span><span class="p">]:</span>
                            <span class="n">loss</span> <span class="o">+=</span> <span class="n">loss_forget_gate</span> <span class="o">*</span> <span class="mi">8</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lstm_input_gate_loss&#39;</span><span class="p">]:</span>
                            <span class="n">loss</span> <span class="o">+=</span> <span class="n">loss_input_gate</span> <span class="o">*</span> <span class="mi">18</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                        <span class="k">del</span> <span class="n">loss</span>
                        <span class="n">avgkspacelossphase</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_phase</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossmag</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_mag</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossforget_gate</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_forget_gate</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossinput_gate</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_input_gate</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="k">del</span> <span class="n">loss_phase</span>
                        <span class="k">del</span> <span class="n">loss_mag</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                        <span class="n">loss_real</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">-</span> <span class="n">og_coiled_vids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

                        <span class="n">loss_l1</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">-</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">loss_l2</span> <span class="o">=</span> <span class="p">(((</span><span class="n">predr</span><span class="o">-</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">avgkspacelossreal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_real</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">kspacessim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgkspace_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgkspace_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">loss_real</span>
                
                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                    <span class="n">predr_sos</span> <span class="o">=</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">loss_l1_sos</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr_sos</span> <span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">loss_l2_sos</span> <span class="o">=</span> <span class="p">(((</span><span class="n">predr_sos</span> <span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">ss1_sos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                    <span class="n">ss1_sos</span> <span class="o">=</span> <span class="n">ss1_sos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">loss_ss1_sos</span> <span class="o">=</span> <span class="n">ss1_sos</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">sosssim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_ss1_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                    <span class="n">avgsos_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                    <span class="n">avgsos_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;coil_combine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOS&#39;</span><span class="p">:</span>
                    <span class="n">predr</span> <span class="o">=</span> <span class="p">((</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>
                    <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="p">[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;memoise_ispace&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span><span class="o">.</span><span class="n">bulk_set_data</span><span class="p">(</span><span class="n">indices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr</span><span class="p">,</span> <span class="n">targ_vid</span><span class="p">)</span>

            
            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">set_grad_enabled</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">):</span>

                <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">(</span><span class="n">set_to_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                
                <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                
                <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>


                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;center_weighted_loss&#39;</span><span class="p">]:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">gaussian_2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]))</span>

                <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>


                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">:</span>
                    <span class="n">loss_ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msssim_loss</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">loss_ss1</span>
                    <span class="n">loss</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2loss</span><span class="p">(</span><span class="n">outp</span><span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="n">targ_vid</span><span class="o">*</span><span class="n">mask</span><span class="p">)</span>

                    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unet_optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="n">avgispacelossreal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>


                <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">loss_l1</span> <span class="o">=</span> <span class="p">(</span><span class="n">outp</span><span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">loss_l2</span> <span class="o">=</span> <span class="p">(((</span><span class="n">outp</span><span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="n">loss_ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">ispacessim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_ss1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                <span class="n">avgispace_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                <span class="n">avgispace_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CyclicLR&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CyclicLR&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unet_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># AERS: It returns a total of 15 statistics from the epoch: average k-space loss for magnitude, phase, real, forget gate, input gate, SSIM, L1, L2, etc.</span>
        <span class="c1"># AERS: This is only for a single GPU. These needs to be combined in DDP_paradigms_LSTM_nufft.py</span>
        <span class="k">return</span> <span class="n">avgkspacelossmag</span><span class="p">,</span> <span class="n">avgkspacelossphase</span><span class="p">,</span> <span class="n">avgkspacelossreal</span><span class="p">,</span><span class="n">avgkspacelossforget_gate</span><span class="p">,</span> <span class="n">avgkspacelossinput_gate</span><span class="p">,</span> <span class="n">kspacessim_score</span><span class="p">,</span> \
            <span class="n">avgkspace_l1_loss</span><span class="p">,</span> <span class="n">avgkspace_l2_loss</span><span class="p">,</span> <span class="n">sosssim_score</span><span class="p">,</span> <span class="n">avgsos_l1_loss</span><span class="p">,</span> <span class="n">avgsos_l2_loss</span><span class="p">,</span> <span class="n">avgispacelossreal</span><span class="p">,</span> <span class="n">ispacessim_score</span><span class="p">,</span> <span class="n">avgispace_l1_loss</span><span class="p">,</span> <span class="n">avgispace_l2_loss</span></div>


<div class="viewcode-block" id="Trainer.evaluate">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer.evaluate">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">print_loss</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the model after training for one epoch.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">        train (bool): Whether to evaluate on the training set. Default is False.</span>
<span class="sd">        print_loss (bool): Whether to print the loss values. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        tuple: Averaged losses and scores for the evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="n">avgkspacelossphase</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossreal</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspacelossforget_gate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avgkspacelossinput_gate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avgkspacelossmag</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">kspacessim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspace_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgkspace_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispacelossreal</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">sosssim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgsos_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgsos_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ispacessim_score</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispace_l1_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">avgispace_l2_loss</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traintestloader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traintestloader</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span>
            <span class="n">dstr</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
            <span class="n">kspace_skip_frames_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dstr</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ispacetestloader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
                <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispacetestloader</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_testset</span>
                <span class="n">kspace_skip_frames_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispace_trainset</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">set_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
                <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span>
                <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testset</span>
                <span class="n">kspace_skip_frames_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddp_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dloader</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">),</span> <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Testing after Epoch </span><span class="si">{}</span><span class="s2"> on </span><span class="si">{}</span><span class="s2">set&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">dstr</span><span class="p">),</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{desc}</span><span class="s2"> | </span><span class="si">{percentage:3.0f}</span><span class="s2">%|</span><span class="si">{bar:10}{r_bar}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tqdm_object</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dloader</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data_instance</span> <span class="ow">in</span> <span class="n">tqdm_object</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_instance</span>
                    <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mem</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">mem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">skip_kspace</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">predr</span><span class="p">,</span> <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">data_instance</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                        <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_kspace</span><span class="p">:</span>
                    <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">undersampled_fts</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">og_coiled_vids</span> <span class="o">=</span> <span class="n">coilwise_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">og_coiled_fts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">inpt_mag_log</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">og_coiled_fts</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                    <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">og_coiled_fts</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">inpt_mag_log</span><span class="p">)</span>
                    <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">inpt_phase</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">inpt_phase</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                        <span class="n">predr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">loss_mag</span><span class="p">,</span> <span class="n">loss_phase</span><span class="p">,</span> <span class="n">loss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_l1</span><span class="p">,</span> <span class="n">loss_l2</span><span class="p">,</span> <span class="n">ss1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">periods</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">targ_phase</span> <span class="o">=</span> <span class="n">inpt_phase</span><span class="p">,</span> <span class="n">targ_mag_log</span> <span class="o">=</span> <span class="n">inpt_mag_log</span><span class="p">,</span> <span class="n">targ_real</span> <span class="o">=</span> <span class="n">og_coiled_vids</span><span class="p">,</span> <span class="n">og_video</span> <span class="o">=</span> <span class="n">og_video</span><span class="p">)</span>
                        <span class="n">avgkspacelossphase</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_phase</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossmag</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_mag</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossforget_gate</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_forget_gate</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                        <span class="n">avgkspacelossinput_gate</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_input_gate</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                        <span class="n">loss_real</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">-</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

                        <span class="n">loss_l1</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">-</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="n">loss_l2</span> <span class="o">=</span> <span class="p">(((</span><span class="n">predr</span><span class="o">-</span> <span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


                    <span class="n">avgkspacelossreal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_real</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span>

                    
                    <span class="n">kspacessim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgkspace_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgkspace_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>

                    <span class="n">predr_sos</span> <span class="o">=</span> <span class="p">((</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>
                    <span class="n">predr_sos</span> <span class="o">=</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">og_video</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>
                    
                    <span class="n">loss_l1_sos</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr_sos</span> <span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">loss_l2_sos</span> <span class="o">=</span> <span class="p">(((</span><span class="n">predr_sos</span> <span class="o">-</span> <span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">ss1_sos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]),</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">predr_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                    <span class="n">ss1_sos</span> <span class="o">=</span> <span class="n">ss1_sos</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1_sos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">loss_ss1_sos</span> <span class="o">=</span> <span class="n">ss1_sos</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                    <span class="n">sosssim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_ss1_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgsos_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                    <span class="n">avgsos_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2_sos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;coil_combine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOS&#39;</span><span class="p">:</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">predr_sos</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="p">[:,</span><span class="n">kspace_skip_frames_loss</span><span class="p">:]</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unet_mode</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;memoise_ispace&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_mode</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ispace_testset</span><span class="o">.</span><span class="n">bulk_set_data</span><span class="p">(</span><span class="n">indices</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">predr</span><span class="p">,</span> <span class="n">targ_vid</span><span class="p">)</span>

                <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">shape</span>

                <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">targ_vid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="p">(</span><span class="n">predr</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1loss</span><span class="p">(</span><span class="n">outp</span><span class="p">,</span> <span class="n">targ_vid</span><span class="p">)</span>


                <span class="n">outp</span> <span class="o">=</span> <span class="n">outp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                
                
                <span class="n">loss_l1</span> <span class="o">=</span> <span class="p">((</span><span class="n">outp</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="n">targ_vid</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">loss_l2</span> <span class="o">=</span> <span class="p">((((</span><span class="n">outp</span><span class="p">)</span><span class="o">-</span> <span class="p">(</span><span class="n">targ_vid</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">((</span><span class="n">outp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]),</span> <span class="p">(</span><span class="n">targ_vid</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">*</span><span class="n">outp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">loss_ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">loss_l1</span> <span class="o">=</span> <span class="n">loss_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">loss_l2</span> <span class="o">=</span> <span class="n">loss_l2</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                <span class="n">avgispacelossreal</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dloader</span><span class="p">)))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">ispacessim_score</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_ss1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgispace_l1_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l1</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgispace_l2_loss</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">loss_l2</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">total_unskipped_frames</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">avgkspacelossmag</span><span class="p">,</span> <span class="n">avgkspacelossphase</span><span class="p">,</span> <span class="n">avgkspacelossreal</span><span class="p">,</span> <span class="n">avgkspacelossforget_gate</span><span class="p">,</span> <span class="n">avgkspacelossinput_gate</span><span class="p">,</span> <span class="n">kspacessim_score</span><span class="p">,</span> <span class="n">avgkspace_l1_loss</span><span class="p">,</span> <span class="n">avgkspace_l2_loss</span><span class="p">,</span> <span class="n">sosssim_score</span><span class="p">,</span> <span class="n">avgsos_l1_loss</span><span class="p">,</span> <span class="n">avgsos_l2_loss</span><span class="p">,</span> <span class="n">avgispacelossreal</span><span class="p">,</span> <span class="n">ispacessim_score</span><span class="p">,</span> <span class="n">avgispace_l1_loss</span><span class="p">,</span> <span class="n">avgispace_l2_loss</span></div>


<div class="viewcode-block" id="Trainer.time_analysis">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer.time_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">time_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes and prints the average time per frame for the model inference.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tqdm_object</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="p">),</span> <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">testloader</span><span class="p">))</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm_object</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="n">times</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">time_analysis</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">periods</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Average Time Per Frame = </span><span class="si">{}</span><span class="s1"> +- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">times</span><span class="p">)),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;fps.mat&#39;</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;times&#39;</span><span class="p">:</span> <span class="n">times</span><span class="p">})</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="Trainer.visualise_on_real">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer.visualise_on_real">[docs]</a>
    <span class="k">def</span> <span class="nf">visualise_on_real</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">epoch</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the model predictions on actual data and saves the plots.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        epoch (int): The current epoch number.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving plots for actual data&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/actual_data&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">actual_data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">actual_data_path</span>
            <span class="n">actual_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">actual_data_path</span><span class="p">)[</span><span class="s1">&#39;undersampled_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">actual_data</span><span class="o">.</span><span class="n">shape</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                <span class="n">predr</span><span class="p">,</span> <span class="n">predr_kspace</span><span class="p">,</span> <span class="n">loss_mag</span><span class="p">,</span> <span class="n">loss_phase</span><span class="p">,</span> <span class="n">loss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="p">(</span><span class="n">actual_data</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_phase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_mag_log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_real</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">og_video</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">actual_data</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">predr_kspace</span> <span class="o">=</span> <span class="n">predr</span>

            <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Predr nan&#39;</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
            <span class="n">predr</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">sos_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">sos_output</span> <span class="o">=</span> <span class="n">sos_output</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;coil_combine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOS&#39;</span><span class="p">:</span>
                <span class="n">ispace_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">ispace_input</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">predr</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
            
            <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">ispace_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">ispace_outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="p">(</span><span class="n">ispace_input</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="n">num_frames</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span><span class="n">numc</span><span class="p">)</span>
            <span class="n">ispace_outp</span> <span class="o">=</span> <span class="n">ispace_outp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">pred_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">predr</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_frames</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                    <span class="n">ispace_outpi</span> <span class="o">=</span> <span class="n">ispace_outp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>
                    <span class="n">sos_outpi</span> <span class="o">=</span> <span class="n">sos_output</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">myimshow</span><span class="p">(</span><span class="n">sos_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Kspace Prediction + SOS&#39;</span><span class="p">)</span>
                    
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">myimshow</span><span class="p">(</span><span class="n">ispace_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ispace Prediction&#39;</span><span class="p">)</span>

                    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Frame </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">f_num</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;ispace_frame_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_num</span><span class="p">)))</span>
                    


                    <span class="n">kspace_out_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                    <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">f_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]:</span>
                        <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;Loss Skipped&#39;</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">unet_visual_only</span><span class="p">:</span>
                        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">kspace_out_size</span><span class="p">))</span>
                        
                        <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">):</span>

                            <span class="n">mask_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">actual_data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                            <span class="n">ifft_of_undersamp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">actual_data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">],</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                            <span class="n">pred_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">pred_ft</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                            <span class="n">predi</span> <span class="o">=</span> <span class="n">predr_kspace</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                            <span class="n">pred_ilstmi</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">myimshow</span><span class="p">(</span><span class="n">mask_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Undersampled FT&#39;</span><span class="p">)</span>
                            
                            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">myimshow</span><span class="p">(</span><span class="n">ifft_of_undersamp</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IFFT of Undersampled FT&#39;</span><span class="p">)</span>
                            
                            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
                            <span class="n">myimshow</span><span class="p">(</span><span class="n">pred_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;FT predicted by Kspace Model&#39;</span><span class="p">)</span>
                            
                            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">myimshow</span><span class="p">(</span><span class="n">predi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IFFT of Kspace Prediction&#39;</span><span class="p">)</span>

                            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
                            <span class="n">myimshow</span><span class="p">(</span><span class="n">pred_ilstmi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Image Space LSTM Prediction&#39;</span><span class="p">)</span>
                            
                            
                        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Frame </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">f_num</span><span class="p">))</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;frame_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_num</span><span class="p">)))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="Trainer.visualise">
<a class="viewcode-back" href="../DDP_LSTMTrainer_nufft.html#DDP_LSTMTrainer_nufft.Trainer.visualise">[docs]</a>
    <span class="k">def</span> <span class="nf">visualise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes and saves the model predictions on the training or testing data.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        epoch (int): The current epoch number.</span>
<span class="sd">        train (bool): Whether to visualize the training set. Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
            <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traintestloader</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainset</span>
            <span class="n">dstr</span> <span class="o">=</span> <span class="s1">&#39;Train&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">raw_visual_only</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;./images/raw/train&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;./images/train&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testloader</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testset</span>
            <span class="n">dstr</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">raw_visual_only</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;./images/raw/test&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;./images/test&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving plots for </span><span class="si">{}</span><span class="s1"> data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dstr</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">og_video</span><span class="p">,</span> <span class="n">coilwise_targets</span><span class="p">,</span> <span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">coils_used</span><span class="p">,</span> <span class="n">periods</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dloader</span><span class="p">):</span>
                <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">undersampled_fts</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">og_coiled_vids</span> <span class="o">=</span> <span class="n">coilwise_targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">og_coiled_fts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">og_coiled_vids</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">inpt_mag_log</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">og_coiled_fts</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">og_coiled_fts</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">inpt_mag_log</span><span class="p">)</span>
                <span class="n">inpt_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">inpt_phase</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">inpt_phase</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

                <span class="n">batch</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">undersampled_fts</span><span class="o">.</span><span class="n">shape</span>
                
                <span class="n">tot_vids_per_patient</span> <span class="o">=</span> <span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">num_vids_per_patient</span><span class="o">*</span><span class="n">dset</span><span class="o">.</span><span class="n">frames_per_vid_per_patient</span><span class="p">)</span>
                <span class="n">num_vids</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">num_vids</span>
                <span class="n">num_plots</span> <span class="o">=</span> <span class="n">num_vids</span><span class="o">*</span><span class="n">num_frames</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])):</span>
                    <span class="n">predr</span><span class="p">,</span> <span class="n">predr_kspace</span><span class="p">,</span> <span class="n">loss_mag</span><span class="p">,</span> <span class="n">loss_phase</span><span class="p">,</span> <span class="n">loss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrent_model</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">[:</span><span class="n">num_vids</span><span class="p">],</span> <span class="n">masks</span><span class="p">[:</span><span class="n">num_vids</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">periods</span><span class="p">[:</span><span class="n">num_vids</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">targ_phase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_mag_log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_real</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">og_video</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">predr_kspace</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">predr_kspace</span> <span class="o">=</span> <span class="n">predr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">predr_kspace</span> <span class="o">=</span> <span class="n">predr</span>

                <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Predr nan&#39;</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
                <span class="n">predr</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predr</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">sos_output</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="n">sos_output</span> <span class="o">=</span> <span class="n">sos_output</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;coil_combine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOS&#39;</span><span class="p">:</span>
                    <span class="n">ispace_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">predr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">keepdim</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                    <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">ispace_input</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">predr</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                    <span class="n">chan</span> <span class="o">=</span> <span class="mi">1</span>
                
                <span class="n">ispace_input</span> <span class="o">=</span> <span class="n">ispace_input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">targ_vid</span> <span class="o">=</span> <span class="n">og_video</span><span class="p">[:</span><span class="n">num_vids</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="o">*</span><span class="n">num_frames</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>                
                <span class="n">ispace_outp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="p">(</span><span class="n">ispace_input</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="n">num_frames</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span><span class="n">numc</span><span class="p">)</span>
                <span class="n">ispace_outp</span> <span class="o">=</span> <span class="n">ispace_outp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                

                <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="n">num_frames</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                <span class="n">pred_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">predr_kspace</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="n">tot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">num_plots</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_vids</span><span class="p">):</span>
                        <span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">f_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">raw_visual_only</span><span class="p">:</span>
                                <span class="n">og_vidi</span> <span class="o">=</span> <span class="n">og_video</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                                <span class="n">ispace_outpi</span> <span class="o">=</span> <span class="n">ispace_outp</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>
                                <span class="n">sos_outpi</span> <span class="o">=</span> <span class="n">sos_output</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>

                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                
                                <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/ground_truth.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)),</span> <span class="n">og_vidi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/kspace_sos.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)),</span> <span class="n">sos_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/ispace_pred.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)),</span> <span class="n">ispace_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                                <span class="n">og_vidi</span> <span class="o">=</span> <span class="n">og_video</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
                                <span class="n">ispace_outpi</span> <span class="o">=</span> <span class="n">ispace_outp</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>
                                <span class="n">sos_outpi</span> <span class="o">=</span> <span class="n">sos_output</span><span class="p">[</span><span class="n">bi</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="p">:,:]</span>
                                


                                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">myimshow</span><span class="p">(</span><span class="n">og_vidi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ground Truth Frame&#39;</span><span class="p">)</span>


                                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">myimshow</span><span class="p">(</span><span class="n">sos_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Kspace Prediction + SOS&#39;</span><span class="p">)</span>
                                
                                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                                <span class="n">diffvals</span> <span class="o">=</span> <span class="n">show_difference_image</span><span class="p">(</span><span class="n">sos_outpi</span><span class="p">,</span> <span class="n">og_vidi</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference Frame SOS&#39;</span><span class="p">)</span>

                                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                                <span class="n">myimshow</span><span class="p">(</span><span class="n">ispace_outpi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ispace Prediction&#39;</span><span class="p">)</span>
                                
                                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                                <span class="n">diffvals</span> <span class="o">=</span> <span class="n">show_difference_image</span><span class="p">(</span><span class="n">ispace_outpi</span><span class="p">,</span> <span class="n">og_vidi</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference Frame ISpace&#39;</span><span class="p">)</span>
                                <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="k">if</span> <span class="n">f_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]:</span>
                                    <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;Loss Skipped&#39;</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Patient </span><span class="si">{}</span><span class="s2"> Video </span><span class="si">{}</span><span class="s2"> Frame </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">spec</span><span class="p">))</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/io_frame_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)))</span>





                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
                                <span class="n">kspace_out_size</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">kspace_out_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
                            <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">if</span> <span class="n">f_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]:</span>
                                <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;Loss Skipped&#39;</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">unet_visual_only</span><span class="p">:</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">raw_visual_only</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">):</span>
                                        <span class="n">targi</span> <span class="o">=</span> <span class="n">og_coiled_vids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                                        <span class="n">orig_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">og_coiled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">mask_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">undersampled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">ifft_of_undersamp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">],</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                                        <span class="n">pred_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">pred_ft</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">predi</span> <span class="o">=</span> <span class="n">predr_kspace</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                                        <span class="n">pred_ilstmi</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>


                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/coiled_gt_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">targi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/coiled_gt_ft_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">orig_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/undersampled_ft_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">mask_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/undersampled_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">ifft_of_undersamp</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/pred_kspace_ft_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">pred_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/pred_kspace_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">predi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="n">plt</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">/pred_image_lstm_coil_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)),</span> <span class="n">pred_ilstmi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">36</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">kspace_out_size</span><span class="p">))</span>
                                    
                                    <span class="n">num_plots</span> <span class="o">-=</span> <span class="mi">1</span>
                                    <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">num_plots</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="k">return</span>
                                        
                                        <span class="n">targi</span> <span class="o">=</span> <span class="n">og_coiled_vids</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span> <span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                                        <span class="n">orig_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">og_coiled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">mask_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">undersampled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">ifft_of_undersamp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">undersampled_fts</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">],</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                                        <span class="n">pred_fti</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">pred_ft</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                                        <span class="n">predi</span> <span class="o">=</span> <span class="n">predr_kspace</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="n">bi</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                                        <span class="n">pred_ilstmi</span> <span class="o">=</span> <span class="n">predr</span><span class="o">.</span><span class="n">cpu</span><span class="p">()[</span><span class="mi">0</span><span class="p">,</span><span class="n">f_num</span><span class="p">,</span><span class="n">c_num</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">targi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coiled Ground Truth&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">((</span><span class="n">orig_fti</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;FT of Coiled Ground Truth&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">mask_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Undersampled FT&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">ifft_of_undersamp</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IFFT of Undersampled FT&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">pred_fti</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;FT predicted by Kspace Model&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">6</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">predi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;IFFT of Kspace Prediction&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>
                                        <span class="n">diffvals</span> <span class="o">=</span> <span class="n">show_difference_image</span><span class="p">(</span><span class="n">predi</span><span class="p">,</span> <span class="n">targi</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference Image&#39;</span><span class="p">)</span>

                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
                                        <span class="n">myimshow</span><span class="p">(</span><span class="n">pred_ilstmi</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ISpace LSTM Prediction&#39;</span><span class="p">)</span>
                                        
                                        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">kspace_out_size</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="o">*</span><span class="n">c_num</span><span class="o">+</span><span class="mi">9</span><span class="p">)</span>
                                        <span class="n">diffvals</span> <span class="o">=</span> <span class="n">show_difference_image</span><span class="p">(</span><span class="n">pred_ilstmi</span><span class="p">,</span> <span class="n">targi</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">c_num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Difference Image&#39;</span><span class="p">)</span>
                                        
                                    <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="k">if</span> <span class="n">f_num</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]:</span>
                                        <span class="n">spec</span> <span class="o">=</span> <span class="s1">&#39;Loss Skipped&#39;</span>
                                    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Patient </span><span class="si">{}</span><span class="s2"> Video </span><span class="si">{}</span><span class="s2"> Frame </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">,</span> <span class="n">spec</span><span class="p">))</span>
                                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;./patient_</span><span class="si">{}</span><span class="s1">/by_location_number/location_</span><span class="si">{}</span><span class="s1">/frame_</span><span class="si">{}</span><span class="s1">.jpg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_num</span><span class="p">,</span> <span class="n">v_num</span><span class="p">,</span> <span class="n">f_num</span><span class="p">)))</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

                            <span class="n">tot</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">break</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, AERS + NRM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>