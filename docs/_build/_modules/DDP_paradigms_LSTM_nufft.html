<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DDP_paradigms_LSTM_nufft &#8212; FOURIER-Net 20240614 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=6ad00ebc"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>FOURIER-Net 20240614 documentation</span></a></h1>
        <h2 class="heading"><span>DDP_paradigms_LSTM_nufft</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for DDP_paradigms_LSTM_nufft</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">neptune</span> <span class="k">as</span> <span class="nn">neptune</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">import</span> <span class="nn">torch.multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">neptune.types</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">datasets</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.distributed</span> <span class="kn">import</span> <span class="n">DistributedSampler</span>                    <span class="c1"># AERS: This is the library that calls for a pause/wait untiil all processes reach a certain point. This is what collected the multi-processes data from the several GPUs.</span>
<span class="kn">from</span> <span class="nn">torch.nn.parallel</span> <span class="kn">import</span> <span class="n">DistributedDataParallel</span> <span class="k">as</span> <span class="n">DDP</span>

<div class="viewcode-block" id="setup">
<a class="viewcode-back" href="../DDP_paradigms_LSTM_nufft.html#DDP_paradigms_LSTM_nufft.setup">[docs]</a>
<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>                                             <span class="c1"># AERS: rank is the process number (child #1, child #2, etc). </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the process group for distributed training.</span>

<span class="sd">    This function initializes the process group using either &#39;gloo&#39; or &#39;nccl&#39; backend</span>
<span class="sd">    based on the GPU configuration provided in args. It also sets the master address</span>
<span class="sd">    and port for communication.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------    </span>
<span class="sd">    rank : int</span>
<span class="sd">        The rank of the current process.</span>
<span class="sd">    world_size : int</span>
<span class="sd">        The total number of processes.</span>
<span class="sd">    args : Namespace</span>
<span class="sd">        Arguments containing the port number and GPU configuration.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MASTER_ADDR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>                                    <span class="c1"># AERS: Initializes the process group. Standard code from pyTorch documentation.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MASTER_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="s2">&quot;gloo&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="s2">&quot;nccl&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span></div>


<div class="viewcode-block" id="cleanup">
<a class="viewcode-back" href="../DDP_paradigms_LSTM_nufft.html#DDP_paradigms_LSTM_nufft.cleanup">[docs]</a>
<span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans up the process group for distributed training.</span>

<span class="sd">    This function destroys the process group, ensuring that all processes are properly</span>
<span class="sd">    terminated and resources are released.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">destroy_process_group</span><span class="p">()</span></div>


<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../&#39;</span><span class="p">)</span>

<span class="n">SAVE_INTERVAL</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="train_paradigm">
<a class="viewcode-back" href="../DDP_paradigms_LSTM_nufft.html#DDP_paradigms_LSTM_nufft.train_paradigm">[docs]</a>
<span class="k">def</span> <span class="nf">train_paradigm</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trains a distributed model for cardiac MRI reconstruction using DDP.</span>
<span class="sd">    </span>
<span class="sd">    This function sets up the environment for distributed training, initializes the dataset and models,</span>
<span class="sd">    loads checkpoint if resuming, and trains the model over a specified number of epochs. Training and</span>
<span class="sd">    validation losses are logged, and model checkpoints are saved periodically.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rank: int</span>
<span class="sd">        The rank of the current process.</span>
<span class="sd">    world_size : int</span>
<span class="sd">        The total number of processes.</span>
<span class="sd">    args : Namespace</span>
<span class="sd">        Arguments containing paths, GPU configuration, logging options, etc.</span>
<span class="sd">    parameters : dict</span>
<span class="sd">        Training parameters including dataset configuration, model parameters, and training options.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>                                               <span class="c1"># AERS: Standard syntax for multi-GPU processes</span>
    <span class="n">proc_device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;acdc&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils.myDatasets.ACDC_radial_faster</span> <span class="kn">import</span> <span class="n">ACDC_radial</span> <span class="k">as</span> <span class="n">dataset</span>
        <span class="kn">from</span> <span class="nn">utils.myDatasets.ACDC_radial_faster</span> <span class="kn">import</span> <span class="n">ACDC_radial_ispace</span> <span class="k">as</span> <span class="n">dataset_ispace</span>
    <span class="kn">from</span> <span class="nn">utils.models.periodLSTM</span> <span class="kn">import</span> <span class="n">fetch_models</span> <span class="k">as</span> <span class="n">rnn_func</span>
    <span class="n">Model_Kspace</span><span class="p">,</span> <span class="n">Model_Ispace</span> <span class="o">=</span> <span class="n">rnn_func</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>                           <span class="c1"># AERS: Imports references of the  k-space and image model classes </span>
    <span class="kn">from</span> <span class="nn">utils.Trainers.DDP_LSTMTrainer_nufft</span> <span class="kn">import</span> <span class="n">Trainer</span>                    <span class="c1"># AERS: Imports Trainer</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>                                               <span class="c1"># AERS: Creates experiment folder on the NAS (as defined in params.py normally)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">):]</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;save_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>

    <span class="n">trainset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span>                                                         <span class="c1"># AERS: ACDC_radial</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span>                                      <span class="c1"># AERS: dataset location</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>                                      <span class="c1"># AERS: pass a COPY of the parameters, so they don&#39;t get changed during processing</span>
                        <span class="n">proc_device</span><span class="p">,</span>                                            <span class="c1"># AERS: Niraj said he was going to delete this but didn&#39;t. It doesn&#39;t get used inside ACDC_radial_faster.py</span>
                        <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                    <span class="p">)</span>
    <span class="n">testset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span> 
                        <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                        <span class="n">proc_device</span><span class="p">,</span>
                        <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                    <span class="p">)</span>
    
    <span class="c1"># AERS: If training for image space, you can change if we want to memoize it in params.py. BUT YOU SHOULD MEMOIZE!</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;memoise_ispace&#39;</span><span class="p">]):</span>
        <span class="n">ispace_trainset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ispace_testset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ispace_trainset</span> <span class="o">=</span> <span class="n">dataset_ispace</span><span class="p">(</span>                                       <span class="c1"># AERS: ACDC_radial_ispace</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span> 
                            <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                            <span class="n">proc_device</span><span class="p">,</span>
                            <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                        <span class="p">)</span>
        <span class="n">ispace_testset</span> <span class="o">=</span> <span class="n">dataset_ispace</span><span class="p">(</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span> 
                            <span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                            <span class="n">proc_device</span><span class="p">,</span>
                            <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="p">)</span>
    <span class="c1"># AERS: In Niraj&#39;s version of the code in vide, kspace_model contains the k-space RNN and image LSTM. He mentioned that when running this code, this will not have an image LSTM. That&#39;s why the names don&#39;t match.</span>
    <span class="c1"># It is the recurrent module, it has the k-space RNN and image LSTM</span>
    <span class="n">recurrent_model</span> <span class="o">=</span> <span class="n">Model_Kspace</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>         <span class="c1"># AERS: recurrent model is called kspace_model in Niraj&#39;s video. Explanation above. </span>
    <span class="n">coil_combine_unet</span> <span class="o">=</span> <span class="n">Model_Ispace</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>       <span class="c1"># AERS: coil_combine_unet is called ispace_model in final version</span>
    
    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;checkpoints/&#39;</span><span class="p">)</span>                       <span class="c1"># AERS: creates folder for checkpoints in save_path. Every epoch, it will store the model weights and everything needed to resume training.</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="n">exist_ok</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>                                   <span class="c1">#       In Niraj&#39;s code, checkpoints are in the NAS so they can be accessed from any system.</span>

    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;GPUs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                                                   <span class="c1"># AERS: sets up Neptune to log training and results</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">):</span>
                <span class="n">run_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">neptune</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;fcrl/Cardiac-MRI-Reconstruction&quot;</span><span class="p">,</span>
                    <span class="n">custom_run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">api_token</span><span class="o">=</span><span class="s2">&quot;eyJhcGlfYWRkcmVzcyI6Imh0dHBzOi8vYXBwLm5lcHR1bmUuYWkiLCJhcGlfdXJsIjoiaHR0cHM6Ly9hcHAubmVwdHVuZS5haSIsImFwaV9rZXkiOiJiNGY0MGNmMi05YWI0LTQ0MDMtYmYzMy04ODZjZDE0NTRmMzkifQ==&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">neptune</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;fcrl/Cardiac-MRI-Reconstruction&quot;</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">api_token</span><span class="o">=</span><span class="s2">&quot;eyJhcGlfYWRkcmVzcyI6Imh0dHBzOi8vYXBwLm5lcHR1bmUuYWkiLCJhcGlfdXJsIjoiaHR0cHM6Ly9hcHAubmVwdHVuZS5haSIsImFwaV9rZXkiOiJiNGY0MGNmMi05YWI0LTQ0MDMtYmYzMy04ODZjZDE0NTRmMzkifQ==&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run</span><span class="p">[</span><span class="s2">&quot;sys/id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()},</span> <span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">)</span>
            <span class="n">run</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">resume</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;visualize&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;visualize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>                                                                     <span class="c1"># AERS: If we want to resume training, it loads the dictionary from the checkpoint path</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;state.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint at model state </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;checkpoint_</span><span class="si">{}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span><span class="n">map_location</span> <span class="o">=</span> <span class="n">proc_device</span><span class="p">)</span>
        <span class="n">pre_e</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
        <span class="n">recurrent_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_model&#39;</span><span class="p">])</span>                         <span class="c1"># AERS: Loads k-space and image model weights and loss functions</span>
        <span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;coil_combine_unet&#39;</span><span class="p">])</span>                     <span class="c1"># AERS: Loads U-NET (coil combination)</span>
        <span class="n">opt_dict_recurrent</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_optim&#39;</span><span class="p">]</span>                                     <span class="c1"># AERS: Loads the dictionaries. Note that the dictionary of the optimizer or scheduler are not loaded here because they are not defined yet.</span>
        <span class="n">opt_dict_unet</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;unet_optim&#39;</span><span class="p">]</span>                                               <span class="c1"># AERS: The optimizer is defined inside the Trainer. So, first the Trainer is definer, then the optimizer and Trainer dictionaries are loaded.</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">scheduler_dict_unet</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;unet_scheduler&#39;</span><span class="p">]</span>
            <span class="n">scheduler_dict_recurrent</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_scheduler&#39;</span><span class="p">]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                                                   <span class="c1"># AERS: Any  printing is only performed by the fist child. Otherwise, repeated messages will appear.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming Training after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dic</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="mi">0</span>                                 <span class="c1"># AERS: This is to resume k-space training. Therefore, it is always model_state 0. In mode=1, both k-space RNN and image LSTM are trained. In mode=2, only the U-NET. </span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                   <span class="c1"># AERS: This will not load the image space, scheduler, optimizer or model. Just k-space.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint at model state </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;checkpoint_</span><span class="si">{}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span><span class="n">map_location</span> <span class="o">=</span> <span class="n">proc_device</span><span class="p">)</span>
        <span class="n">pre_e</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
        <span class="n">recurrent_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_model&#39;</span><span class="p">])</span>
        <span class="c1"># coil_combine_unet.load_state_dict(dic[&#39;coil_combine_unet&#39;])</span>
        <span class="n">opt_dict_recurrent</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_optim&#39;</span><span class="p">]</span>
        <span class="c1"># opt_dict_unet = dic[&#39;unet_optim&#39;]</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="n">scheduler_dict_unet</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;unet_scheduler&#39;</span><span class="p">]</span>
            <span class="n">scheduler_dict_recurrent</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_scheduler&#39;</span><span class="p">]</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming Training after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dic</span>
    <span class="k">else</span><span class="p">:</span>                                   <span class="c1"># AERS: When starting from scratch.</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pre_e</span> <span class="o">=</span><span class="mi">0</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">opt_dict_recurrent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">opt_dict_unet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scheduler_dict_unet</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">scheduler_dict_recurrent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Training&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># AERS: Related to DDP library. DDP is a class that stores the model inside that will handle training in multiple GPUs. Coordinates the weights and merging of them.</span>
    <span class="n">recurrent_model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">recurrent_model</span><span class="p">,</span> <span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]],</span> <span class="n">output_device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">find_unused_parameters</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">coil_combine_unet</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">coil_combine_unet</span><span class="p">,</span> <span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]],</span> <span class="n">output_device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">find_unused_parameters</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># AERS: Definition of the Trainer. This class is where everything actually happes.</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">recurrent_model</span><span class="p">,</span> <span class="n">coil_combine_unet</span><span class="p">,</span> <span class="n">ispace_trainset</span><span class="p">,</span> <span class="n">ispace_testset</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">testset</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">time_analysis</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">time_analysis</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">unet_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">opt_dict_unet</span><span class="p">)</span>
        <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">opt_dict_recurrent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">unet_scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">scheduler_dict_unet</span><span class="p">)</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">scheduler_dict_recurrent</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]):</span>         <span class="c1"># AERS: for the number of epochs we want to run, copy/paste a bunch of data.  </span>
        <span class="k">if</span> <span class="n">pre_e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                                       <span class="c1"># AERS: This is a way is skipping the previously done epochs. </span>
            <span class="n">pre_e</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="c1"># AERS: Collects train and test losses from the 15 statistics returned by the Trainer (once per GPU). collected_train_losses and collected_train_losses are accumulators.</span>
        <span class="n">collected_train_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">,)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>    
        <span class="n">collected_test_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">,)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>
        
        <span class="c1">################# MODEL TRAINING ################# </span>
        <span class="n">kspaceloss_mag</span><span class="p">,</span> <span class="n">kpsaceloss_phase</span><span class="p">,</span> <span class="n">kspaceloss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="n">kspacessim</span><span class="p">,</span> \
            <span class="n">kpsaceloss_l1</span><span class="p">,</span> <span class="n">kspaceloss_l2</span><span class="p">,</span> <span class="n">sosssim_score</span><span class="p">,</span> <span class="n">sosl1_score</span><span class="p">,</span> <span class="n">sosl2_score</span><span class="p">,</span> <span class="n">ispaceloss_real</span><span class="p">,</span> <span class="n">ispacessim</span><span class="p">,</span> <span class="n">ipsaceloss_l1</span><span class="p">,</span> <span class="n">ispaceloss_l2</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        
        <span class="c1"># AERS: Gathers all the 15 values, inside collected_train_losses, which is a multi-processing library function. </span>
        <span class="c1"># AERS: This is needed because DDP collects and averages the model weights, but not the losses. That is what this is doing.</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">collected_train_losses</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">kspaceloss_mag</span><span class="p">,</span> <span class="n">kpsaceloss_phase</span><span class="p">,</span> <span class="n">kspaceloss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="n">kspacessim</span><span class="p">,</span> \
                                                              <span class="n">kpsaceloss_l1</span><span class="p">,</span> <span class="n">kspaceloss_l2</span><span class="p">,</span> <span class="n">sosssim_score</span><span class="p">,</span> <span class="n">sosl1_score</span><span class="p">,</span> <span class="n">sosl2_score</span><span class="p">,</span> <span class="n">ispaceloss_real</span><span class="p">,</span> <span class="n">ispacessim</span><span class="p">,</span> <span class="n">ipsaceloss_l1</span><span class="p">,</span> <span class="n">ispaceloss_l2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgkspace_train_mag_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>                   <span class="c1"># AERS: Sums losses across GPUs</span>
            <span class="n">avgkspace_train_phase_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_train_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_train_forget_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_train_input_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">kspacessim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">kspacel1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">kspacel2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">sosssim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">sosl1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">sosl2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">avgispace_train_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">ispacessim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">ispacel1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">ispacel2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>

            <span class="c1"># AERS: Neptune log</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/epochs_trained&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_mag_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_mag_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_phase_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_phase_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_forget_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_forget_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_input_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_input_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kspacessim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kspacel1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspace_train_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">kspacel2_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sos_train_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sosssim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sos_train_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sosl1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sos_train_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sosl2_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispace_train_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_train_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispace_train_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ispacessim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispace_train_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ispacel1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispace_train_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ispacel2_score</span><span class="p">)</span>
            
            <span class="c1"># AERS: Prints results per epoch</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Training Losses for Epoch </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Mag Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_mag_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Phase Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_phase_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Real Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Forget Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_forget_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Input Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_input_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kspacessim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SOS Training Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sosl1_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sosl2_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sosssim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ISpace Training Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace Real (L1) Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_train_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace SSIM = </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ispacessim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1">################# MODEL EVALUATION ################# </span>

        <span class="n">kspaceloss_mag</span><span class="p">,</span> <span class="n">kpsaceloss_phase</span><span class="p">,</span> <span class="n">kspaceloss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="n">kspacessim</span><span class="p">,</span> <span class="n">kpsaceloss_l1</span><span class="p">,</span> <span class="n">kspaceloss_l2</span><span class="p">,</span> <span class="n">test_sosssim_score</span><span class="p">,</span> \
            <span class="n">test_sosl1_score</span><span class="p">,</span> <span class="n">test_sosl2_score</span><span class="p">,</span> <span class="n">ispaceloss_real</span><span class="p">,</span> <span class="n">ispacessim</span><span class="p">,</span> <span class="n">ipsaceloss_l1</span><span class="p">,</span> <span class="n">ispaceloss_l2</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">collected_test_losses</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">kspaceloss_mag</span><span class="p">,</span> <span class="n">kpsaceloss_phase</span><span class="p">,</span> <span class="n">kspaceloss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="n">kspacessim</span><span class="p">,</span> \
                                                             <span class="n">kpsaceloss_l1</span><span class="p">,</span> <span class="n">kspaceloss_l2</span><span class="p">,</span> <span class="n">test_sosssim_score</span><span class="p">,</span> <span class="n">test_sosl1_score</span><span class="p">,</span> <span class="n">test_sosl2_score</span><span class="p">,</span> <span class="n">ispaceloss_real</span><span class="p">,</span> <span class="n">ispacessim</span><span class="p">,</span> <span class="n">ipsaceloss_l1</span><span class="p">,</span> <span class="n">ispaceloss_l2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgkspace_test_mag_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_phase_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_forget_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_input_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_kspacessim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_kspacel1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_kspacel2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">test_sosssim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_sosl1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_sosl2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">avgispace_test_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_ispacessim_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_ispacel1_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">test_ispacel2_score</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>

            <span class="c1"># AERS: Neptune log</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_mag_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_mag_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_phase_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_phase_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_forget_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_forget_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_input_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_input_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_kspacessim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_kspacel1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/kspacetest_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_kspacel2_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sostest_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_sosssim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sostest_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_sosl1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/sostest_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_sosl2_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispacetest_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_test_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispacetest_ssim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_ispacessim_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispacetest_l1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_ispacel1_score</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train/ispacetest_l2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">test_ispacel2_score</span><span class="p">)</span>
            
            <span class="c1"># AERS: Prints results per epoch</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Test Losses for Epoch </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Mag Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_mag_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Phase Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_phase_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Real Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Forget Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_forget_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Input Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_input_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_kspacessim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SOS Test Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_sosl1_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_sosl2_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_sosssim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ISpace Test Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace Real (L1) Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_test_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_ispacessim_score</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># AERS: Saves results</span>

        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avgkspace_train_mag_loss</span><span class="p">,</span><span class="n">avgkspace_train_phase_loss</span><span class="p">,</span><span class="n">avgkspace_train_real_loss</span><span class="p">,</span><span class="n">avgkspace_train_forget_gate_loss</span><span class="p">,</span><span class="n">avgkspace_train_input_gate_loss</span><span class="p">,</span><span class="n">kspacessim_score</span><span class="p">,</span>\
                           <span class="n">kspacel1_score</span><span class="p">,</span><span class="n">kspacel2_score</span><span class="p">,</span><span class="n">sosssim_score</span><span class="p">,</span><span class="n">sosl1_score</span><span class="p">,</span><span class="n">sosl2_score</span><span class="p">,</span><span class="n">avgispace_train_real_loss</span><span class="p">,</span><span class="n">ispacessim_score</span><span class="p">,</span><span class="n">ispacel1_score</span><span class="p">,</span><span class="n">ispacel2_score</span><span class="p">))</span>
            <span class="n">test_losses</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avgkspace_test_mag_loss</span><span class="p">,</span> <span class="n">avgkspace_test_phase_loss</span><span class="p">,</span> <span class="n">avgkspace_test_real_loss</span><span class="p">,</span> <span class="n">avgkspace_test_forget_gate_loss</span><span class="p">,</span> <span class="n">avgkspace_test_input_gate_loss</span><span class="p">,</span> <span class="n">test_kspacessim_score</span><span class="p">,</span> \
                                 <span class="n">test_kspacel1_score</span><span class="p">,</span> <span class="n">test_kspacel2_score</span><span class="p">,</span> <span class="n">test_sosssim_score</span><span class="p">,</span> <span class="n">test_sosl1_score</span><span class="p">,</span> <span class="n">test_sosl2_score</span><span class="p">,</span> <span class="n">avgispace_test_real_loss</span><span class="p">,</span> <span class="n">test_ispacessim_score</span><span class="p">,</span> <span class="n">test_ispacel1_score</span><span class="p">,</span> <span class="n">test_ispacel2_score</span><span class="p">))</span>

            <span class="c1"># AERS: This is updated here for Neptune and in the dictionary</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;train_losses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">losses</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_losses</span>

            <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_model</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>                <span class="c1"># AERS: Saves the k-space model that is inside the Trainer</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;coil_combine_unet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>            <span class="c1"># AERS: Saves the U-NET model</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_optim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_optim</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>                       <span class="c1"># AERS: Saves the opimizer for k-space RNN and image space LSTM</span>

            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;unet_optim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">unet_optim</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>                                 <span class="c1"># AERS: Saves the opimizer for the U-NET</span>
            <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;scheduler&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>                                               <span class="c1"># AERS: Scheduler is a cyclic LR (helps escape local minima)</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;unet_scheduler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">unet_scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
                <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_scheduler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">recurrent_scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">losses</span>
            <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_losses</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SAVE_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                                      <span class="c1"># AERS: Saves the model state</span>
                <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]:</span>
                    <span class="n">model_state</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_windowed&#39;</span><span class="p">]:</span>
                    <span class="n">model_state</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">elif</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_ilstm&#39;</span><span class="p">]:</span>
                    <span class="n">model_state</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">model_state</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;checkpoint_</span><span class="si">{}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">))</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">model_state</span><span class="p">},</span> <span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;state.pth&#39;</span><span class="p">)</span>
                <span class="c1"># model_state += 1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving model after </span><span class="si">{}</span><span class="s1"> Epochs</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##########################################################################################&#39;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">dic</span>
        <span class="k">del</span> <span class="n">collected_test_losses</span>
        <span class="k">del</span> <span class="n">collected_train_losses</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="s1">&#39;status.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="n">cleanup</span><span class="p">()</span>                           <span class="c1"># AERS: Kills all the processes at the end.</span></div>



<div class="viewcode-block" id="test_paradigm">
<a class="viewcode-back" href="../DDP_paradigms_LSTM_nufft.html#DDP_paradigms_LSTM_nufft.test_paradigm">[docs]</a>
<span class="k">def</span> <span class="nf">test_paradigm</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>                                         <span class="c1"># AERS: Same as the training paradigm, but just loads the models, does not evaluate. This is done in single GPU.</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests a distributed model for cardiac MRI reconstruction using DDP.</span>

<span class="sd">    This function sets up the environment for distributed testing, initializes the dataset and models,</span>
<span class="sd">    loads checkpoint if resuming, and evaluates the model on the test dataset. Test losses are logged,</span>
<span class="sd">    and model performance is visualized if specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rank : int</span>
<span class="sd">        The rank of the current process.</span>
<span class="sd">    world_size : int</span>
<span class="sd">        The total number of processes.</span>
<span class="sd">    args : Namespace</span>
<span class="sd">        Arguments containing paths, GPU configuration, logging options, etc.</span>
<span class="sd">    parameters : dict</span>
<span class="sd">    Testing parameters including dataset configuration, model parameters, and testing options.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">])</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">proc_device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;acdc&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils.myDatasets.ACDC_radial_faster</span> <span class="kn">import</span> <span class="n">ACDC_radial</span> <span class="k">as</span> <span class="n">dataset</span>
    <span class="kn">from</span> <span class="nn">utils.models.periodLSTM</span> <span class="kn">import</span> <span class="n">fetch_models</span> <span class="k">as</span> <span class="n">rnn_func</span>
    <span class="n">Model_Kspace</span><span class="p">,</span> <span class="n">Model_Ispace</span> <span class="o">=</span> <span class="n">rnn_func</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">utils.Trainers.DDP_LSTMTrainer_nufft</span> <span class="kn">import</span> <span class="n">Trainer</span>

    <span class="n">temp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">temp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;experiments&#39;</span><span class="p">):]</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;save_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
        <span class="n">trainset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span> 
                            <span class="n">parameters</span><span class="p">,</span>
                            <span class="n">proc_device</span><span class="p">,</span>
                            <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                            <span class="n">visualise_only</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">visualise_only</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">numbers_only</span> 
                        <span class="p">)</span>
        <span class="n">testset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">(</span>
                            <span class="n">args</span><span class="o">.</span><span class="n">dataset_path</span><span class="p">,</span> 
                            <span class="n">parameters</span><span class="p">,</span>
                            <span class="n">proc_device</span><span class="p">,</span>
                            <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">visualise_only</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">visualise_only</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">numbers_only</span> 
                        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trainset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">testset</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">ispace_trainset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ispace_testset</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="n">recurrent_model</span> <span class="o">=</span> <span class="n">Model_Kspace</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>
    <span class="n">coil_combine_unet</span> <span class="o">=</span> <span class="n">Model_Ispace</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>
    <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;checkpoints/&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">):</span>
                <span class="n">run_id</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))[</span><span class="s1">&#39;run_id&#39;</span><span class="p">]</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">neptune</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;fcrl/Cardiac-MRI-Reconstruction&quot;</span><span class="p">,</span>
                    <span class="n">custom_run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">api_token</span><span class="o">=</span><span class="s2">&quot;eyJhcGlfYWRkcmVzcyI6Imh0dHBzOi8vYXBwLm5lcHR1bmUuYWkiLCJhcGlfdXJsIjoiaHR0cHM6Ly9hcHAubmVwdHVuZS5haSIsImFwaV9rZXkiOiJkZDU2NDJjMy1lNzczLTRkZDEtODAwYy01MWFlM2VmN2Q4ZTEifQ==&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">neptune</span><span class="o">.</span><span class="n">init_run</span><span class="p">(</span>
                    <span class="n">project</span><span class="o">=</span><span class="s2">&quot;fcrl/Cardiac-MRI-Reconstruction&quot;</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">api_token</span><span class="o">=</span><span class="s2">&quot;eyJhcGlfYWRkcmVzcyI6Imh0dHBzOi8vYXBwLm5lcHR1bmUuYWkiLCJhcGlfdXJsIjoiaHR0cHM6Ly9hcHAubmVwdHVuZS5haSIsImFwaV9rZXkiOiJkZDU2NDJjMy1lNzczLTRkZDEtODAwYy01MWFlM2VmN2Q4ZTEifQ==&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">({</span><span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="n">run</span><span class="p">[</span><span class="s2">&quot;sys/id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fetch</span><span class="p">()},</span> <span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;neptune_run.pth&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;visualize&quot;</span><span class="p">):</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;visualize&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;state.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">))[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint at model state </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;checkpoint_</span><span class="si">{}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span><span class="n">map_location</span> <span class="o">=</span> <span class="n">proc_device</span><span class="p">)</span>
        <span class="n">pre_e</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
        <span class="n">recurrent_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_model&#39;</span><span class="p">])</span>
        <span class="n">coil_combine_unet</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;coil_combine_unet&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading kspace model after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming Training after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dic</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">resume_kspace</span><span class="p">:</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading checkpoint at model state </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dic</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;checkpoint_</span><span class="si">{}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_state</span><span class="p">),</span><span class="n">map_location</span> <span class="o">=</span> <span class="n">proc_device</span><span class="p">)</span>
        <span class="n">pre_e</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]</span>
        <span class="n">recurrent_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;recurrent_model&#39;</span><span class="p">])</span>
        <span class="c1"># coil_combine_unet.load_state_dict(dic[&#39;coil_combine_unet&#39;])</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading kspace model after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dic</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">]),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;losses&#39;</span><span class="p">]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="s1">&#39;test_losses&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Resuming Training after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">dic</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model_state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pre_e</span> <span class="o">=</span><span class="mi">0</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">test_losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scheduler_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting Training&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># recurrent_model = DDP(recurrent_model, device_ids = None, output_device = None, find_unused_parameters = False)</span>
    <span class="n">recurrent_model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">recurrent_model</span><span class="p">,</span> <span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]],</span> <span class="n">output_device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">find_unused_parameters</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">coil_combine_unet</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">coil_combine_unet</span><span class="p">,</span> <span class="n">device_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">]],</span> <span class="n">output_device</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">[</span><span class="n">rank</span><span class="p">],</span> <span class="n">find_unused_parameters</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">recurrent_model</span><span class="p">,</span> <span class="n">coil_combine_unet</span><span class="p">,</span> <span class="n">ispace_trainset</span><span class="p">,</span> <span class="n">ispace_testset</span><span class="p">,</span> <span class="n">trainset</span><span class="p">,</span> <span class="n">testset</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">time_analysis</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">time_analysis</span><span class="p">()</span>
        <span class="k">return</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_on_real</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">numbers_only</span><span class="p">:</span>
                <span class="n">trainer</span><span class="o">.</span><span class="n">visualise_on_real</span><span class="p">(</span><span class="n">pre_e</span><span class="p">)</span>
        <span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># if args.neptune_log and rank == 0:</span>
        <span class="c1">#     for x in sorted(os.listdir(os.path.join(args.run_id, &#39;images/train&#39;))):</span>
        <span class="c1">#         run[&#39;train/{}&#39;.format(x)].upload(File(os.path.join(args.run_id, &#39;images/train/{}&#39;.format(x))))</span>
        <span class="c1">#         break</span>
        <span class="c1">#     for x in sorted(os.listdir(os.path.join(args.run_id, &#39;images/test&#39;))):</span>
        <span class="c1">#         run[&#39;test/{}&#39;.format(x)].upload(File(os.path.join(args.run_id, &#39;images/test/{}&#39;.format(x))))</span>
        <span class="c1">#         break</span>

        <span class="c1"># train_losses contain</span>
                    <span class="c1"># train_kspace_mag_loss</span>
                    <span class="c1"># train_kspace_phase_loss</span>
                    <span class="c1"># train_kspace_real_loss</span>
                    <span class="c1"># train_kspace_forget_gate_loss</span>
                    <span class="c1"># train_kspace_input_gate_loss</span>
                    <span class="c1"># train_kspace_ssim_score</span>
                    <span class="c1"># train_kspace_l1_score</span>
                    <span class="c1"># train_kspace_l2_score</span>
                    <span class="c1"># train_sos_ssim_score</span>
                    <span class="c1"># train_sos_l1_score</span>
                    <span class="c1"># train_sos_l2_score</span>
                    <span class="c1"># train_ispace_real_loss</span>
                    <span class="c1"># train_ispace_ssim_score</span>
                    <span class="c1"># train_ispace_l1_score</span>
                    <span class="c1"># train_ispace_l2_score</span>
        <span class="c1"># test_losses contain </span>
                    <span class="c1"># test_kspace_mag_loss</span>
                    <span class="c1"># test_kspace_phase_loss</span>
                    <span class="c1"># test_kspace_real_loss</span>
                    <span class="c1"># test_kspace_forget_gate_loss</span>
                    <span class="c1"># test_kspace_input_gate_loss</span>
                    <span class="c1"># test_kspace_ssim_score</span>
                    <span class="c1"># test_kspace_l1_score</span>
                    <span class="c1"># test_kspace_l2_score</span>
                    <span class="c1"># test_sos_ssim_score</span>
                    <span class="c1"># test_sos_l1_score</span>
                    <span class="c1"># test_sos_l2_score</span>
                    <span class="c1"># test_ispace_real_loss</span>
                    <span class="c1"># test_ispace_ssim_score</span>
                    <span class="c1"># test_ispace_l1_score</span>
                    <span class="c1"># test_ispace_l2_score</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># AERS: Number of epochs that have been trained (for the image space LSTM, it removes the k-space RNN epochs because in those values, the losses would be zero)</span>
        <span class="n">kspace_x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)))</span>
        <span class="n">ispace_x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace Mag Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_mag_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace Phase Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_phase_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace Real Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_real_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace Forget gate Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_forget_gate_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace Input gate Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_input_gate_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace SSIM score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Kspace L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_kspace_l2_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train SOS ssim score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_sos_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train SOS L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_sos_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train SOS L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_sos_l2_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Ispace Real Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_ispace_real_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Ispace SSIM score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_ispace_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Ispace L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_ispace_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Train Ispace L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/train_ispace_l2_score.png&#39;</span><span class="p">))</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace Mag Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_mag_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace Phase Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_phase_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace Real Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_real_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace Forget gate Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_forget_gate_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace Input gate Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_input_gate_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace SSIM score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Kspace L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_kspace_l2_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test SOS ssim score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_sos_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test SOS L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_sos_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test SOS L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kspace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_sos_l2_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Ispace Real Loss after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_ispace_real_loss.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Ispace SSIM score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_ispace_ssim_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Ispace L1 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_ispace_l1_score.png&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Test Ispace L2 score after </span><span class="si">{}</span><span class="s1"> epochs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ispace_x</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_losses</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_total&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;num_epochs_unet&#39;</span><span class="p">])],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;epoch&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;loss&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;images/test_ispace_l2_score.png&#39;</span><span class="p">))</span>
        

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">numbers_only</span><span class="p">:</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">visualise</span><span class="p">(</span><span class="n">pre_e</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>         <span class="c1"># AERS: If the argument numbers_only is True, it doesn&#39;t save the plots</span>
            <span class="n">trainer</span><span class="o">.</span><span class="n">visualise</span><span class="p">(</span><span class="n">pre_e</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">visualise_only</span><span class="p">:</span>                             <span class="c1"># AERS: If the argument visualise_only is True, it saves all the plots for a single patient and two locations</span>
        <span class="n">test_kspaceloss_mag</span><span class="p">,</span> <span class="n">test_kspaceloss_phase</span><span class="p">,</span> <span class="n">test_kspaceloss_real</span><span class="p">,</span> <span class="n">test_loss_forget_gate</span><span class="p">,</span> <span class="n">test_loss_input_gate</span><span class="p">,</span> <span class="n">test_kspacessim</span><span class="p">,</span> \
            <span class="n">test_kspaceloss_l1</span><span class="p">,</span> <span class="n">test_kspaceloss_l2</span><span class="p">,</span> <span class="n">avgsos_test_ssim</span><span class="p">,</span> <span class="n">avgsos_test_l1</span><span class="p">,</span> <span class="n">avgsos_test_l2</span><span class="p">,</span> <span class="n">test_ispaceloss_real</span><span class="p">,</span> <span class="n">test_ispacessim</span><span class="p">,</span> <span class="n">test_ispaceloss_l1</span><span class="p">,</span> <span class="n">test_ispaceloss_l2</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pre_e</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">collected_test_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">,)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">collected_test_losses</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">test_kspaceloss_mag</span><span class="p">,</span> <span class="n">test_kspaceloss_phase</span><span class="p">,</span> <span class="n">test_kspaceloss_real</span><span class="p">,</span> <span class="n">test_loss_forget_gate</span><span class="p">,</span> \
                                                             <span class="n">test_loss_input_gate</span><span class="p">,</span> <span class="n">test_kspacessim</span><span class="p">,</span> <span class="n">test_kspaceloss_l1</span><span class="p">,</span> <span class="n">test_kspaceloss_l2</span><span class="p">,</span> <span class="n">avgsos_test_ssim</span><span class="p">,</span> \
                                                                <span class="n">avgsos_test_l1</span><span class="p">,</span> <span class="n">avgsos_test_l2</span><span class="p">,</span> <span class="n">test_ispaceloss_real</span><span class="p">,</span> <span class="n">test_ispacessim</span><span class="p">,</span> <span class="n">test_ispaceloss_l1</span><span class="p">,</span> <span class="n">test_ispaceloss_l2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgkspace_test_mag_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_phase_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_forget_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_input_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgkspace_test_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">avgsos_test_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgsos_test_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgsos_test_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">avgispace_test_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgispace_test_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgispace_test_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
            <span class="n">avgispace_test_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_test_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_mag_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_mag_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_phase_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_phase_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_forget_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_forget_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_input_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_input_gate_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_ssim</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_l1</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetest_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_test_l2</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostest_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_test_ssim</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostest_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_test_l1</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostest_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_test_l2</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetest_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_test_real_loss</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetest_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_test_ssim</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetest_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_test_l1</span><span class="p">)</span>
                <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetest_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_test_l2</span><span class="p">)</span>


            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Test Losses After Epoch </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Mag Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_mag_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Phase Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_phase_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Real Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Forget Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_forget_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Input Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_input_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_test_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SOS Test Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_test_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_test_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_test_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ISpace Test Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace Real (L1) Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_test_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_test_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_test_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace SSIM = </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_test_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">test_only</span><span class="p">:</span>                           <span class="c1"># AERS: If the argument test_only is True</span>
            <span class="n">train_kspaceloss_mag</span><span class="p">,</span> <span class="n">train_kspaceloss_phase</span><span class="p">,</span> <span class="n">train_kspaceloss_real</span><span class="p">,</span> <span class="n">train_loss_forget_gate</span><span class="p">,</span> <span class="n">train_loss_input_gate</span><span class="p">,</span> <span class="n">train_kspacessim</span><span class="p">,</span> <span class="n">train_kspaceloss_l1</span><span class="p">,</span> <span class="n">train_kspaceloss_l2</span><span class="p">,</span> <span class="n">avgsos_train_ssim</span><span class="p">,</span> \
                <span class="n">avgsos_train_l1</span><span class="p">,</span> <span class="n">avgsos_train_l2</span><span class="p">,</span> <span class="n">train_ispaceloss_real</span><span class="p">,</span> <span class="n">train_ispacessim</span><span class="p">,</span> <span class="n">train_ispaceloss_l1</span><span class="p">,</span> <span class="n">train_ispaceloss_l2</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">pre_e</span><span class="p">,</span> <span class="n">train</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">collected_train_losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">,)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">world_size</span><span class="p">)]</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">all_gather</span><span class="p">(</span><span class="n">collected_train_losses</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">train_kspaceloss_mag</span><span class="p">,</span> <span class="n">train_kspaceloss_phase</span><span class="p">,</span> <span class="n">train_kspaceloss_real</span><span class="p">,</span> <span class="n">train_loss_forget_gate</span><span class="p">,</span> <span class="n">train_loss_input_gate</span><span class="p">,</span> <span class="n">train_kspacessim</span><span class="p">,</span> \
                                                                  <span class="n">train_kspaceloss_l1</span><span class="p">,</span> <span class="n">train_kspaceloss_l2</span><span class="p">,</span> <span class="n">avgsos_train_ssim</span><span class="p">,</span> <span class="n">avgsos_train_l1</span><span class="p">,</span> <span class="n">avgsos_train_l2</span><span class="p">,</span> <span class="n">train_ispaceloss_real</span><span class="p">,</span> <span class="n">train_ispacessim</span><span class="p">,</span> \
                                                                    <span class="n">train_ispaceloss_l1</span><span class="p">,</span> <span class="n">train_ispaceloss_l2</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">avgkspace_train_mag_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_phase_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_forget_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_input_gate_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgkspace_train_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">avgsos_train_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgsos_train_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgsos_train_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="n">avgispace_train_real_loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgispace_train_ssim</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgispace_train_l1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">)</span>
                <span class="n">avgispace_train_l2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">collected_train_losses</span><span class="p">])</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">gpu</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">neptune_log</span> <span class="ow">and</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_mag_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_mag_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_phase_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_phase_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_real_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_forget_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_forget_gate_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_input_gate_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_input_gate_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_ssim</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_l1</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/kspacetrain_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgkspace_train_l2</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostrain_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_train_ssim</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostrain_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_train_l1</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/sostrain_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgsos_train_l2</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetrain_real_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_train_real_loss</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetrain_ssim_score&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_train_ssim</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetrain_l1_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_train_l1</span><span class="p">)</span>
                    <span class="n">run</span><span class="p">[</span><span class="s2">&quot;test/ispacetrain_l2_loss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">avgispace_train_l2</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Train Losses After Epoch </span><span class="si">{}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre_e</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Mag Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_mag_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Phase Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_phase_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Real Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Forget Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_forget_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace Input Gate Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_input_gate_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;KSpace SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgkspace_train_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SOS Train Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_train_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_train_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOS SSIM = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgsos_train_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ISpace Train Losses:&#39;</span><span class="p">,</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace Real (L1) Loss = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_train_real_loss</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace L1 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_train_l1</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace L2 = </span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_train_l2</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ISpace SSIM = </span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avgispace_train_ssim</span><span class="p">),</span> <span class="n">flush</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="s1">&#39;status.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

    <span class="n">cleanup</span><span class="p">()</span></div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, AERS + NRM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>