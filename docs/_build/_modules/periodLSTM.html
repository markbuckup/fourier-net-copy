<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>periodLSTM &#8212; FOURIER-Net 20240614 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=f63d8bfa" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=6ad00ebc"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>FOURIER-Net 20240614 documentation</span></a></h1>
        <h2 class="heading"><span>periodLSTM</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for periodLSTM</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">kornia</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">utils.models.complexCNNs.cmplx_conv</span> <span class="k">as</span> <span class="nn">cmplx_conv</span>
<span class="kn">import</span> <span class="nn">utils.models.complexCNNs.cmplx_dropout</span> <span class="k">as</span> <span class="nn">cmplx_dropout</span>
<span class="kn">import</span> <span class="nn">utils.models.complexCNNs.cmplx_upsample</span> <span class="k">as</span> <span class="nn">cmplx_upsample</span>
<span class="kn">import</span> <span class="nn">utils.models.complexCNNs.cmplx_activation</span> <span class="k">as</span> <span class="nn">cmplx_activation</span>
<span class="kn">import</span> <span class="nn">utils.models.complexCNNs.radial_bn</span> <span class="k">as</span> <span class="nn">radial_bn</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">utils.functions</span> <span class="kn">import</span> <span class="n">fetch_loss_function</span>

<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-10</span>
<span class="n">CEPS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">EPS</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">EPS</span><span class="p">))</span>

<div class="viewcode-block" id="Identity">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.Identity">[docs]</a>
<span class="k">class</span> <span class="nc">Identity</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple identity module - placeholder for absent modules during ablation studies</span>

<span class="sd">    Attributes</span>
<span class="sd">    --------</span>
<span class="sd">        n_rnn_cells : int</span>
<span class="sd">            Place holder argument</span>
<span class="sd">        m : nn.Module</span>
<span class="sd">            Place holder attribute so that the module has parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image_lstm</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>   <span class="c1"># AERS: Added param_dic because sphinx needed it</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Identity</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image_lstm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="n">n_rnn_cells</span>
        
    
<div class="viewcode-block" id="Identity.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.Identity.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_mag</span><span class="p">,</span> <span class="n">hist_phase</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mag_prev_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phase_prev_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Place holder Forward pass - **will never be used**</span>

<span class="sd">        Args:</span>
<span class="sd">        --------</span>
<span class="sd">        hist_mag : Tensor</span>
<span class="sd">            Historical magnitude data.</span>
<span class="sd">        hist_phase : Tensor</span>
<span class="sd">            Historical phase data.</span>
<span class="sd">        gt_mask : Tensor, optional</span>
<span class="sd">            Ground truth mask.</span>
<span class="sd">        mag_prev_outputs : Tensor, optional</span>
<span class="sd">            Previous magnitude outputs.</span>
<span class="sd">        phase_prev_outputs : Tensor, optional</span>
<span class="sd">            Previous phase outputs.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">            Tuple[List[Tensor], List[Tensor]]</span>
<span class="sd">                The same outputs as input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_mag_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hist_mag</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>
        <span class="n">new_phase_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hist_phase</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>
        
        <span class="k">return</span> <span class="n">new_mag_outputs</span><span class="p">,</span> <span class="n">new_phase_outputs</span></div>
</div>


<div class="viewcode-block" id="Identity_param">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.Identity_param">[docs]</a>
<span class="k">class</span> <span class="nc">Identity_param</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A identity module - placeholder for absent modules during ablation studies</span>

<span class="sd">    Attributes:</span>
<span class="sd">        m (nn.Module): Linear transformation layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        AERS</span>
<span class="sd">        Initialize the Identity_param module.</span>

<span class="sd">        This method initializes an instance of the Identity_param module, setting up the internal </span>
<span class="sd">        components and parameters. It includes a placeholder linear layer as an example.</span>

<span class="sd">        Args:</span>
<span class="sd">        -----</span>
<span class="sd">        - parameters (dict): </span>
<span class="sd">            A dictionary containing the configuration parameters for the module. </span>
<span class="sd">            The specific contents and structure of this dictionary depend on the use case.</span>
<span class="sd">        - proc_device (str): </span>
<span class="sd">            The device on which the module&#39;s computations will be performed. Typically, this </span>
<span class="sd">            is either &#39;cpu&#39; or &#39;cuda&#39; to specify the processing device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Identity_param</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        
<div class="viewcode-block" id="Identity_param.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.Identity_param.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Placeholder Forward pass of the Identity_param module.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (Tensor): Input tensor.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tensor: x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">x</span></div>
</div>



<div class="viewcode-block" id="mylog">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.mylog">[docs]</a>
<span class="k">def</span> <span class="nf">mylog</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the logarithm of a tensor with a specified base.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (Tensor): Input tensor.</span>
<span class="sd">        base (int, optional): Logarithm base. Defaults to 10.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Logarithm of the input tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">log10</span><span class="p">()</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">log10</span><span class="p">()</span></div>


<div class="viewcode-block" id="gaussian_2d">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.gaussian_2d">[docs]</a>
<span class="k">def</span> <span class="nf">gaussian_2d</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a 2D Gaussian mask.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        shape (tuple): Shape of the output array (height, width).</span>
<span class="sd">        sigma (float): Standard deviation of the Gaussian distribution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: 2D Gaussian mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">5</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ss</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ogrid</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">:</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))</span>
    <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">*</span> <span class="n">h</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sum_h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sum_h</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">/=</span> <span class="n">sum_h</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">h</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">*=</span> <span class="mi">9</span>
    <span class="n">h</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">h</span></div>


<div class="viewcode-block" id="special_trim">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.special_trim">[docs]</a>
<span class="k">def</span> <span class="nf">special_trim</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">95</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trims the values of a tensor to be within the specified percentiles.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (Tensor): Input tensor.</span>
<span class="sd">        l (int, optional): Lower percentile. Defaults to 5.</span>
<span class="sd">        u (int, optional): Upper percentile. Defaults to 95.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tensor: Trimmed tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">percentile_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">percentile_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">l</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">percentile_5</span><span class="p">,</span> <span class="n">percentile_95</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="fetch_models">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.fetch_models">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_models</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches the LSTM model types based on the given parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        parameters : dict</span>
<span class="sd">            Dictionary of parameters.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[Type[nn.Module], Type[nn.Module]]: LSTM model types for image and k-space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ispace_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ispace_architecture&#39;</span><span class="p">]</span>
    <span class="n">kspace_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;kspace_architecture&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ispace_name</span> <span class="o">==</span> <span class="s1">&#39;ILSTM1&#39;</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">ImageSpaceModel1</span>
    <span class="k">elif</span> <span class="n">ispace_name</span> <span class="o">==</span> <span class="s1">&#39;Identity&#39;</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">Identity_param</span>

    <span class="k">if</span> <span class="n">kspace_name</span> <span class="o">==</span> <span class="s1">&#39;KSpace_RNN&#39;</span><span class="p">:</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">convLSTM_Kspace1</span>
    <span class="k">if</span> <span class="n">kspace_name</span> <span class="o">==</span> <span class="s1">&#39;MDCNN&#39;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">utils.models.MDCNN</span> <span class="kn">import</span> <span class="n">MDCNN</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">MDCNN</span>
    <span class="k">return</span> <span class="n">km</span><span class="p">,</span> <span class="n">im</span></div>


<div class="viewcode-block" id="concatConv">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.concatConv">[docs]</a>
<span class="k">class</span> <span class="nc">concatConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenated convolutional layers module.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    layerlist : nn.ModuleList</span>
<span class="sd">        List of convolutional layers.</span>
<span class="sd">    skip_connections : bool</span>
<span class="sd">        Flag for using skip connections.</span>
<span class="sd">    relu_func : nn.Module</span>
<span class="sd">        ReLU activation function.</span>
<span class="sd">    n_layers : int</span>
<span class="sd">        Number of layers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnn_func</span><span class="p">,</span> <span class="n">relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">hidden_channels</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="n">gate_output_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the concatConv module.</span>

<span class="sd">        Args:</span>
<span class="sd">        ----------</span>
<span class="sd">        - cnn_func : Type[nn.Module]</span>
<span class="sd">            Convolution function - real or complex.</span>
<span class="sd">        - relu_func : Type[nn.Module]</span>
<span class="sd">            ReLU function.</span>
<span class="sd">        - gate_input_size : int, optional</span>
<span class="sd">            Input size of the gate. Defaults to 8.</span>
<span class="sd">        - hidden_channels : int, optional</span>
<span class="sd">            Number of hidden channels. Defaults to 32.</span>
<span class="sd">        - gate_output_size : int, optional</span>
<span class="sd">            Output size of the gate. Defaults to 1.</span>
<span class="sd">        - n_layers : int, optional</span>
<span class="sd">            Number of layers. Defaults to 4.</span>
<span class="sd">        - skip_connections : bool, optional</span>
<span class="sd">            Flag for using skip connections. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">concatConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span> <span class="o">=</span> <span class="n">skip_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu_func</span> <span class="o">=</span> <span class="n">relu_func</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="n">gate_output_size</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">inlen</span> <span class="o">=</span> <span class="n">hidden_channels</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">:</span>
                <span class="n">skiplen</span> <span class="o">=</span> <span class="n">gate_input_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">skiplen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnn_func</span><span class="p">(</span><span class="n">inlen</span><span class="o">+</span><span class="n">skiplen</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">inlen</span> <span class="o">=</span> <span class="n">hidden_channels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnn_func</span><span class="p">(</span><span class="n">inlen</span><span class="o">+</span><span class="n">skiplen</span><span class="p">,</span> <span class="n">gate_output_size</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="p">)</span>

<div class="viewcode-block" id="concatConv.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.concatConv.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the concatConv module.</span>

<span class="sd">        Args:</span>
<span class="sd">        ----------</span>
<span class="sd">        x : Tensor</span>
<span class="sd">            Input tensor.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        Tensor</span>
<span class="sd">            Output tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>

        <span class="n">to_cat</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">curr_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n_layers</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">:</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">curr_output</span><span class="p">,</span> <span class="n">to_cat</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">input</span> <span class="o">=</span> <span class="n">curr_output</span>
            <span class="n">curr_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu_func</span><span class="p">(</span><span class="n">layer</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">curr_output</span><span class="p">,</span> <span class="n">to_cat</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">curr_output</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layerlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="nb">input</span><span class="p">)</span></div>
</div>




<div class="viewcode-block" id="RecurrentModule">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.RecurrentModule">[docs]</a>
<span class="k">class</span> <span class="nc">RecurrentModule</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Recurrent Module for undersampled k-space data processing. Contains the kspace-RNN and the image LSTM.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">        Various attributes for LSTM cell configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">history_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_coils</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">forget_gate_coupled</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">forget_gate_same_coils</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">forget_gate_same_phase_mag</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">rnn_input_mask</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">n_hidden</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">coilwise</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gate_cat_prev_output</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the convLSTMcell_kspace module.</span>

<span class="sd">        Args:</span>
<span class="sd">        ----------</span>
<span class="sd">        history_length : int, optional</span>
<span class="sd">            Length of the history to append to the undersampled input. Appends historical frames from previous cardiac cycles. </span>
<span class="sd">                Defaults to 0.</span>
<span class="sd">        num_coils : int, optional</span>
<span class="sd">            Number of coils. </span>
<span class="sd">                Defaults to 8.</span>
<span class="sd">        forget_gate_coupled : bool, optional</span>
<span class="sd">            Flag for coupled forget gate - forget gate mask and input gate mask sum to 1. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        forget_gate_same_coils : bool, optional</span>
<span class="sd">            Flag for same forget gate for all coils. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        forget_gate_same_phase_mag : bool, optional</span>
<span class="sd">            Flag for same forget gate for phase and magnitude. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        rnn_input_mask : bool, optional</span>
<span class="sd">            Flag for appending the mask of the locations of newly acquired data to the RNN input. </span>
<span class="sd">                Defaults to True.</span>
<span class="sd">        skip_connections : bool, optional</span>
<span class="sd">            Flag for having skip connections. </span>
<span class="sd">                Defaults to False.</span>
<span class="sd">        n_layers : int, optional</span>
<span class="sd">            Number of layers in the K-space RNN gates. </span>
<span class="sd">                Defaults to 3.</span>
<span class="sd">        n_hidden :int, optional</span>
<span class="sd">            Number of channels in the K-space RNN gates. </span>
<span class="sd">                Defaults to 12.</span>
<span class="sd">        n_rnn_cells : int, optional</span>
<span class="sd">            Number of RNN cells - can be coupled one after the other. </span>
<span class="sd">                Defaults to 1.</span>
<span class="sd">        coilwise : bool, optional</span>
<span class="sd">            If enabled, each coil of the input is processed independently. </span>
<span class="sd">                Defaults to True.</span>
<span class="sd">        gate_cat_prev_output : bool, optional</span>
<span class="sd">            Flag for appending the previously predicted frame to the RNN input. </span>
<span class="sd">                Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RecurrentModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="n">n_rnn_cells</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span> <span class="o">=</span> <span class="n">n_hidden</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_length</span> <span class="o">=</span> <span class="n">history_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span> <span class="o">=</span> <span class="n">num_coils</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span> <span class="o">=</span> <span class="n">skip_connections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coilwise</span> <span class="o">=</span> <span class="n">coilwise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_coupled</span> <span class="o">=</span> <span class="n">forget_gate_coupled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_coils</span> <span class="o">=</span> <span class="n">forget_gate_same_coils</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span> <span class="o">=</span> <span class="n">forget_gate_same_phase_mag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rnn_input_mask</span> <span class="o">=</span> <span class="n">rnn_input_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_cat_prev_output</span> <span class="o">=</span> <span class="n">gate_cat_prev_output</span>
        
        <span class="n">mag_cnn_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span>
        <span class="n">mag_relu_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span>
        
        <span class="n">phase_cnn_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span>
        <span class="n">phase_relu_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">phase_activation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coilwise</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">gate_input_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_cat_prev_output</span><span class="p">:</span>
                <span class="n">gate_input_size</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gate_input_size</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_cat_prev_output</span><span class="p">:</span>
                <span class="n">gate_input_size</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn_input_mask</span><span class="p">:</span>
            <span class="n">gate_input_size</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">hidden_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_hidden</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_coils</span><span class="p">:</span>
            <span class="n">forget_gate_output_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">forget_gate_output_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mag_inputGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">mag_cnn_func</span><span class="p">,</span> <span class="n">mag_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase_inputGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">phase_cnn_func</span><span class="p">,</span> <span class="n">phase_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_coupled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_forgetGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">mag_cnn_func</span><span class="p">,</span> <span class="n">mag_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phase_forgetGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">phase_cnn_func</span><span class="p">,</span> <span class="n">phase_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_outputGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">mag_cnn_func</span><span class="p">,</span> <span class="n">mag_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_outputGates</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">phase_cnn_func</span><span class="p">,</span> <span class="n">phase_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_inputProcs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">mag_cnn_func</span><span class="p">,</span> <span class="n">mag_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_inputProcs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">concatConv</span><span class="p">(</span><span class="n">phase_cnn_func</span><span class="p">,</span> <span class="n">phase_relu_func</span><span class="p">,</span> <span class="n">gate_input_size</span><span class="p">,</span> <span class="n">hidden_channels</span><span class="p">,</span> <span class="n">forget_gate_output_size</span><span class="p">,</span> <span class="n">n_layers</span> <span class="o">=</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_connections</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)])</span>
        

<div class="viewcode-block" id="RecurrentModule.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.RecurrentModule.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hist_mag</span><span class="p">,</span> <span class="n">hist_phase</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mag_prev_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phase_prev_outputs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">eval</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the RecurrentModule.</span>

<span class="sd">        Args:</span>
<span class="sd">            hist_mag (Tensor): Log Magnitude data. If history is provided, then this will have multiple frames appended as channnels.</span>
<span class="sd">            hist_phase (Tensor): Phase data as angles. If history is provided, then this will have multiple frames appended as channnels.</span>
<span class="sd">            background (Tensor, optional): Background mask. Defaults to None.</span>
<span class="sd">            gt_mask (Tensor, optional): Ground truth mask. Defaults to None.</span>
<span class="sd">            mag_prev_outputs (Tensor, optional): Previous magnitude outputs. Defaults to None.</span>
<span class="sd">            phase_prev_outputs (Tensor, optional): Previous phase outputs. Defaults to None.</span>
<span class="sd">            window_size (int, optional): Window size for gating. Defaults to np.inf.</span>
<span class="sd">            mag_gates_remember (list, optional): List to remember magnitude gates to enforce windowing. Defaults to None.</span>
<span class="sd">            phase_gates_remember (list, optional): List to remember phase gates to enforce windowing. Defaults to None.</span>
<span class="sd">            eval (bool, optional): Evaluation flag - if yes, then do not compute loss. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[Tensor], List[Tensor], Tensor, Tensor, List, List]: New magnitude and phase outputs, loss for forget gate, loss for input gate, remembered magnitude gates, remembered phase gates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="n">gt_mask</span>
        <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">hist_mag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">foreground</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">background</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mag_prev_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coilwise</span><span class="p">:</span>
                <span class="n">mag_shape1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">phase_shape1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mag_shape1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">phase_shape1</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">mag_prev_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mag_shape1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">hist_mag</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>
            <span class="n">phase_prev_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">phase_shape1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">hist_phase</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>


        <span class="n">og_B</span><span class="p">,</span> <span class="n">og_C</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coilwise</span><span class="p">:</span>
            <span class="n">hist_mag</span> <span class="o">=</span> <span class="n">hist_mag</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="o">*</span><span class="n">og_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_mag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">hist_phase</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="o">*</span><span class="n">og_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">foreground</span> <span class="o">=</span> <span class="n">foreground</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="o">*</span><span class="n">og_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="c1"># gt_mask = gt_mask.repeat((1, self.num_coils,1,1)).reshape(og_B*og_C, 1, *hist_phase.shape[2:])</span>
            <span class="k">for</span> <span class="n">i_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">):</span>
                <span class="n">mag_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">mag_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="o">*</span><span class="n">og_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">mag_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">phase_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="o">*</span><span class="n">og_C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">phase_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="n">new_mag_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hist_mag</span><span class="p">]</span>
        <span class="n">new_phase_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">hist_phase</span><span class="p">]</span>
        <span class="n">loss_forget_gate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">loss_input_gate</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">criterionL1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span>
        <span class="n">criterionL2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mag_gates_remember</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
                <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">i_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rnn_input_mask</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_cat_prev_output</span><span class="p">:</span>
                    <span class="n">mag_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">new_mag_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">],</span> <span class="n">hist_mag</span><span class="p">,</span> <span class="n">foreground</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">phase_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">new_phase_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">],</span> <span class="n">hist_phase</span><span class="p">,</span> <span class="n">foreground</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mag_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">hist_mag</span><span class="p">,</span> <span class="n">foreground</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">phase_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">hist_phase</span><span class="p">,</span> <span class="n">foreground</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_cat_prev_output</span><span class="p">:</span>
                    <span class="n">mag_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">new_mag_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">],</span> <span class="n">hist_mag</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">phase_inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">new_phase_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">],</span> <span class="n">hist_phase</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mag_inp_cat</span> <span class="o">=</span> <span class="n">hist_mag</span>
                    <span class="n">phase_inp_cat</span> <span class="o">=</span> <span class="n">hist_phase</span>


            <span class="n">mag_it</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_inputGates</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">mag_inp_cat</span><span class="p">))</span>
            <span class="n">mag_ot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_outputGates</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">mag_inp_cat</span><span class="p">))</span>
            <span class="n">phase_ot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_outputGates</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">phase_inp_cat</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
                <span class="n">phase_it</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_inputGates</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">phase_inp_cat</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase_it</span> <span class="o">=</span> <span class="n">mag_it</span>

            
            <span class="n">loss_forget_gate</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">mag_it</span><span class="o">*</span><span class="n">foreground</span><span class="p">,</span> <span class="n">foreground</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_coils</span><span class="p">:</span>
                <span class="n">mag_it</span> <span class="o">=</span> <span class="n">mag_it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">phase_it</span> <span class="o">=</span> <span class="n">phase_it</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mag_ot</span> <span class="o">=</span> <span class="n">mag_ot</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">phase_ot</span> <span class="o">=</span> <span class="n">phase_ot</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">input_gate_output_size</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">mag_gates_remember</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag_it</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
                <span class="n">phase_gates_remember</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_it</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">window_size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">mag_ft</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mag_it</span>
                <span class="n">phase_ft</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">phase_it</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mag_gates_remember</span><span class="p">[</span><span class="n">i_cell</span><span class="p">][</span><span class="o">-</span><span class="n">window_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mag_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">mag_gates_remember</span><span class="p">[</span><span class="n">i_cell</span><span class="p">][</span><span class="o">-</span><span class="n">window_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">mag_it</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">mag_it</span>
                    <span class="n">mag_ft</span> <span class="o">=</span> <span class="n">mag_ft</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forget_gate_same_phase_mag</span><span class="p">:</span>
                        <span class="n">phase_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">phase_gates_remember</span><span class="p">[</span><span class="n">i_cell</span><span class="p">][</span><span class="o">-</span><span class="n">window_size</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">phase_it</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">phase_it</span>
                        <span class="n">phase_ft</span> <span class="o">=</span> <span class="n">phase_ft</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">phase_ft</span> <span class="o">=</span> <span class="n">mag_ft</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mag_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mag_it</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">mag_it</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
                    <span class="n">phase_ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">phase_it</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">phase_it</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            
            <span class="n">mag_Cthat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_inputProcs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">mag_inp_cat</span><span class="p">)</span>
            <span class="n">phase_Cthat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase_activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phase_inputProcs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">](</span><span class="n">phase_inp_cat</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">eval</span><span class="p">:</span>
                <span class="n">loss_input_gate</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">mag_Cthat</span><span class="o">*</span><span class="n">foreground</span><span class="p">,</span> <span class="n">hist_mag</span><span class="o">*</span><span class="n">foreground</span><span class="p">)</span>
                <span class="n">loss_input_gate</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">phase_Cthat</span><span class="o">*</span><span class="n">foreground</span><span class="p">,</span> <span class="n">hist_phase</span><span class="o">*</span><span class="n">foreground</span><span class="p">)</span>

            <span class="n">new_mag_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag_ot</span><span class="o">*</span><span class="p">((</span><span class="n">mag_ft</span> <span class="o">*</span> <span class="n">mag_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">mag_it</span> <span class="o">*</span> <span class="n">mag_Cthat</span><span class="p">)))</span>
            <span class="n">new_phase_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_ot</span><span class="o">*</span><span class="p">((</span><span class="n">phase_ft</span> <span class="o">*</span> <span class="n">phase_prev_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">phase_it</span> <span class="o">*</span> <span class="n">phase_Cthat</span><span class="p">)))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">eval</span><span class="p">:</span>
                <span class="n">loss_input_gate</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">new_mag_outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">foreground</span><span class="p">,</span> <span class="n">hist_mag</span><span class="o">*</span><span class="n">foreground</span><span class="p">)</span>
                <span class="n">loss_input_gate</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">new_phase_outputs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">foreground</span><span class="p">,</span> <span class="n">hist_phase</span><span class="o">*</span><span class="n">foreground</span><span class="p">)</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coilwise</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rnn_cells</span><span class="p">):</span>
                <span class="n">new_mag_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_mag_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="p">,</span><span class="n">og_C</span><span class="p">,</span><span class="o">*</span><span class="n">new_mag_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">new_phase_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_phase_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">og_B</span><span class="p">,</span><span class="n">og_C</span><span class="p">,</span><span class="o">*</span><span class="n">new_phase_outputs</span><span class="p">[</span><span class="n">i_cell</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">new_mag_outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">new_phase_outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="n">mag_gates_remember</span><span class="p">,</span> <span class="n">phase_gates_remember</span></div>
</div>


<div class="viewcode-block" id="convLSTMcell">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.convLSTMcell">[docs]</a>
<span class="k">class</span> <span class="nc">convLSTMcell</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A convolutional LSTM cell module.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        Various attributes for LSTM cell configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tanh_mode</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">real_mode</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ilstm_gate_cat_prev_output</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the convLSTMcell module.</span>

<span class="sd">        Args:</span>
<span class="sd">            in_channels (int, optional): Number of input channels. Defaults to 1.</span>
<span class="sd">            out_channels (int, optional): Number of output channels. Defaults to 1.</span>
<span class="sd">            tanh_mode (bool, optional): Flag for using tanh activation for the output. Defaults to False.</span>
<span class="sd">            real_mode (bool, optional): Flag for real mode for the layers. Defaults to False.</span>
<span class="sd">            ilstm_gate_cat_prev_output (bool, optional): Flag for concatenating previous output to gate input. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">convLSTMcell</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanh_mode</span> <span class="o">=</span> <span class="n">tanh_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span> <span class="o">=</span> <span class="n">out_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">=</span> <span class="n">in_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_mode</span> <span class="o">=</span> <span class="n">real_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ilstm_gate_cat_prev_output</span> <span class="o">=</span> <span class="n">ilstm_gate_cat_prev_output</span>
        <span class="k">if</span> <span class="n">real_mode</span><span class="p">:</span>
            <span class="n">cnn_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span>
            <span class="n">relu_func</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnn_func</span> <span class="o">=</span> <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span>
            <span class="n">relu_func</span> <span class="o">=</span> <span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanh_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilstm_gate_cat_prev_output</span><span class="p">:</span>
            <span class="n">gate_input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gate_input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputGate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">relu_func</span><span class="p">(),</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forgetGate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">relu_func</span><span class="p">(),</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputGate</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">relu_func</span><span class="p">(),</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputProc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="n">gate_input_size</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">relu_func</span><span class="p">(),</span>
                <span class="n">cnn_func</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">in_channels</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span>
                <span class="n">relu_func</span><span class="p">(),</span>
            <span class="p">)</span>

<div class="viewcode-block" id="convLSTMcell.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.convLSTMcell.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prev_output</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forward pass of the convLSTMcell module.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (Tensor): Input tensor.</span>
<span class="sd">            prev_state (Tensor, optional): Previous cell state. Defaults to None.</span>
<span class="sd">            prev_output (Tensor, optional): Previous output. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Tensor, Tensor]: New cell state and output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prev_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shape1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_channels</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">prev_state</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilstm_gate_cat_prev_output</span><span class="p">:</span>
                <span class="n">prev_output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape1</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilstm_gate_cat_prev_output</span><span class="p">:</span>
            <span class="n">inp_cat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">prev_output</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inp_cat</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">ft</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forgetGate</span><span class="p">(</span><span class="n">inp_cat</span><span class="p">))</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputGate</span><span class="p">(</span><span class="n">inp_cat</span><span class="p">))</span>
        <span class="n">ot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputGate</span><span class="p">(</span><span class="n">inp_cat</span><span class="p">))</span>
        
        <span class="n">Cthat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputProc</span><span class="p">(</span><span class="n">inp_cat</span><span class="p">))</span>
        <span class="n">Ct_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">ft</span> <span class="o">*</span> <span class="n">prev_state</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">it</span> <span class="o">*</span> <span class="n">Cthat</span><span class="p">)</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">Ct_new</span><span class="p">)</span><span class="o">*</span><span class="n">ot</span>
        
        <span class="k">return</span> <span class="n">Ct_new</span><span class="p">,</span> <span class="n">ht</span></div>
</div>


<div class="viewcode-block" id="convLSTM_Kspace1">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.convLSTM_Kspace1">[docs]</a>
<span class="k">class</span> <span class="nc">convLSTM_Kspace1</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">,</span> <span class="n">two_cell</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">convLSTM_Kspace1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;history_length&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">real_mode</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># if not self.param_dic[&#39;skip_kspace_rnn&#39;]:   # AERS: Original from Niraj</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skip_kspace_rnn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>     <span class="c1"># AERS: Edited because sphinx was having an issue with this line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kspace_m</span> <span class="o">=</span> <span class="n">RecurrentModule</span><span class="p">(</span>
                        <span class="n">num_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_coils</span><span class="p">,</span>
                        <span class="n">history_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="p">,</span>
                        <span class="n">forget_gate_coupled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;forget_gate_coupled&#39;</span><span class="p">],</span>
                        <span class="n">forget_gate_same_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;forget_gate_same_coils&#39;</span><span class="p">],</span>
                        <span class="n">forget_gate_same_phase_mag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;forget_gate_same_phase_mag&#39;</span><span class="p">],</span>
                        <span class="n">rnn_input_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rnn_input_mask&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">skip_connections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kspace_rnn_skip_connections&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="n">n_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_layers&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">n_hidden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_hidden&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                        <span class="n">coilwise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;coilwise&#39;</span><span class="p">],</span>
                        <span class="n">gate_cat_prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;gate_cat_prev_output&#39;</span><span class="p">],</span>
                    <span class="p">)</span> 
            
            <span class="c1"># AERS: Edited line 571 from rnn_input_mask = self.param_dic(&#39;rnn_input_mask&#39;), because sphinx had issues with it.</span>
            <span class="c1"># AERS: Edited line 572 from skip_connections = self.param_dic[&#39;kspace_rnn_skip_connections&#39;], because sphinx had issues with it.</span>
            <span class="c1"># AERS: Edited line 573 from n_layers = self.param_dic[&#39;n_layers&#39;],</span>
            <span class="c1"># AERS: Edited line 574 from n_hidden = self.param_dic[&#39;n_hidden&#39;],</span>
            <span class="c1"># AERS: Edited line 575 from n_rnn_cells = self.param_dic[&#39;n_rnn_cells&#39;],</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kspace_m</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">(</span><span class="n">n_rnn_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">],</span> <span class="n">image_lstm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;unet_instead_of_ilstm&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ispacem</span> <span class="o">=</span> <span class="n">UNet</span><span class="p">(</span>
                        <span class="n">in_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                        <span class="n">out_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ispacem</span> <span class="o">=</span> <span class="n">convLSTMcell</span><span class="p">(</span>
                        <span class="n">tanh_mode</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="n">real_mode</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                        <span class="n">in_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                        <span class="n">out_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                        <span class="n">ilstm_gate_cat_prev_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;ilstm_gate_cat_prev_output&#39;</span><span class="p">],</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span> <span class="o">=</span> <span class="n">kornia</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;center_weighted_loss&#39;</span><span class="p">]:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">gaussian_2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">gaussian_2d</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]),</span> <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]</span><span class="o">//</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">mask</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">EPS</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predr_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">proc_device</span><span class="p">)</span>

<div class="viewcode-block" id="convLSTM_Kspace1.time_analysis">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.convLSTM_Kspace1.time_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">time_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_exp</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">ispace_model</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prev_state3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">prev_output3</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="n">length</span> <span class="o">=</span> <span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span>
            <span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_size</span><span class="p">]</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.22</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">dists</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;center_weighted_loss&#39;</span><span class="p">]:</span>
                <span class="n">dists</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cycle_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">&gt;</span> <span class="n">cycle_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">x_size</span><span class="o">//</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cycle_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">cycle_mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            
            <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">start1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="p">)</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">*</span> <span class="n">periods</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">hist_ind</span> <span class="o">+=</span> <span class="n">ti</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="n">hist_ind</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">temp1</span><span class="p">[</span><span class="n">temp1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999999999</span>
                <span class="n">min_vals</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">temp1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">-</span> <span class="n">base</span>
                <span class="n">hist_ind</span><span class="p">[</span><span class="n">hist_ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_ind</span> <span class="o">+</span> <span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

                <span class="n">mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">+</span> <span class="n">mult</span>
                <span class="n">hist_fft</span> <span class="o">=</span> <span class="n">fft_exp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])[</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">hist_mag</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">((</span><span class="n">hist_fft</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">+</span><span class="n">EPS</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span>
                <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">hist_fft</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">hist_mag</span><span class="p">)</span>
                <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">hist_phase</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">hist_phase</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">background</span> <span class="o">=</span> <span class="p">((</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">EPS</span><span class="p">,</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span>
                <span class="n">hist_phase</span><span class="p">[</span><span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">hist_mag</span><span class="p">[</span><span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
                <span class="k">if</span> <span class="n">prev_outputs2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs2</span><span class="p">]</span>
                    <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">4</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs1</span><span class="p">]</span>

                <span class="n">curr_mask</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">random_window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span>
                <span class="n">prev_outputs2</span><span class="p">,</span> <span class="n">prev_outputs1</span><span class="p">,</span> <span class="n">loss_forget_gate_curr</span><span class="p">,</span> <span class="n">loss_input_gate_curr</span><span class="p">,</span> <span class="n">mag_gates_remember</span><span class="p">,</span> <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kspace_m</span><span class="p">(</span>
                                                                                                                                                        <span class="n">hist_mag</span><span class="p">,</span>
                                                                                                                                                        <span class="n">hist_phase</span><span class="p">,</span>
                                                                                                                                                        <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span>
                                                                                                                                                        <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">curr_mask</span><span class="p">,</span>
                                                                                                                                                        <span class="n">mag_prev_outputs</span> <span class="o">=</span> <span class="n">prev_outputs2</span><span class="p">,</span>
                                                                                                                                                        <span class="n">phase_prev_outputs</span> <span class="o">=</span> <span class="n">prev_outputs1</span><span class="p">,</span>
                                                                                                                                                        <span class="n">window_size</span> <span class="o">=</span> <span class="n">random_window_size</span><span class="p">,</span>
                                                                                                                                                        <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="n">mag_gates_remember</span><span class="p">,</span>
                                                                                                                                                        <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="n">phase_gates_remember</span><span class="p">,</span>
                                                                                                                                                        <span class="nb">eval</span> <span class="o">=</span> <span class="kc">True</span>
                                                                                                                                                    <span class="p">)</span>

                <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">cycle_mask</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs2</span><span class="p">]</span>
                <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">cycle_mask</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs1</span><span class="p">]</span>
     
                
                <span class="n">phase_ti</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">prev_outputs1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">prev_outputs1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                <span class="n">lstm_predicted_fft</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">prev_outputs2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">phase_ti</span>
                <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">lstm_predicted_fft</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
                    <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">prev_output3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="n">prev_state3</span><span class="p">,</span> <span class="n">prev_output3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispacem</span><span class="p">(</span><span class="n">predr_ti</span><span class="p">,</span> <span class="n">prev_state3</span><span class="p">,</span> <span class="n">prev_output3</span><span class="p">)</span>
                    <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">predr_ti</span>
                
                <span class="n">predr</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:]</span> <span class="o">=</span> <span class="n">ispace_model</span><span class="p">(</span><span class="n">prev_output3</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                
                <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start1</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">times</span></div>



<div class="viewcode-block" id="convLSTM_Kspace1.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.convLSTM_Kspace1.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fft_exp</span><span class="p">,</span> <span class="n">gt_masks</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">),</span> <span class="n">periods</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_phase</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_mag_log</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">targ_real</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">og_video</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>

        <span class="n">mag_log</span> <span class="o">=</span> <span class="n">mylog</span><span class="p">(</span><span class="n">fft_exp</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">1e20</span><span class="p">),</span> <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">5</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">fft_exp</span> <span class="o">/</span> <span class="p">(</span><span class="n">EPS</span> <span class="o">+</span> <span class="n">fft_exp</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">phase</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_state3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_output3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">ans_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>

        <span class="n">length</span> <span class="o">=</span> <span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_size</span><span class="p">,</span> <span class="n">y_size</span> <span class="o">=</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span>
        <span class="n">x_arr</span><span class="p">,</span> <span class="n">y_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">x_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">y_size</span><span class="p">]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">length</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.22</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">dists</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;center_weighted_loss&#39;</span><span class="p">]:</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cycle_mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y_arr</span> <span class="o">-</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">&gt;</span> <span class="n">cycle_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">x_size</span><span class="o">//</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cycle_mask</span><span class="p">[</span><span class="n">cycle_mask</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cycle_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">cycle_mask</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">predr</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ans_coils</span><span class="p">,</span> <span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">targ_mag_log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targ_mag_log</span> <span class="o">*=</span> <span class="n">cycle_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">targ_phase</span> <span class="o">*=</span> <span class="n">cycle_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
            <span class="n">predr_kspace</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">ans_coils</span><span class="p">,</span> <span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predr_kspace</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">targ_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loss_phase</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_mag</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_forget_gate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_input_gate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_real</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_l1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_l2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_ss1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">criterionL1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">L1Loss</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">criterionL2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">criterionCos</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CosineSimilarity</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_phase</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">loss_mag</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">loss_real</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">loss_forget_gate</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">loss_input_gate</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_l1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_l2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">loss_ss1</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">periods</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[:,</span><span class="n">ti</span><span class="p">]</span>
                <span class="n">hist_mag</span> <span class="o">=</span> <span class="n">mag_log</span><span class="p">[:,</span><span class="n">ti</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">history_length</span><span class="p">)</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">*</span> <span class="n">periods</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
                <span class="n">hist_ind</span> <span class="o">+=</span> <span class="n">ti</span>
                <span class="n">temp1</span> <span class="o">=</span> <span class="n">hist_ind</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">temp1</span><span class="p">[</span><span class="n">temp1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9999999999</span>
                <span class="n">min_vals</span> <span class="o">=</span> <span class="n">temp1</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">temp1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">min_vals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">-</span> <span class="n">base</span>
                <span class="n">hist_ind</span><span class="p">[</span><span class="n">hist_ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">hist_ind</span> <span class="o">+</span> <span class="n">base</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>

                <span class="n">mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">hist_ind</span> <span class="o">=</span> <span class="n">hist_ind</span> <span class="o">+</span> <span class="n">mult</span>      

                <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])[</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">phase</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                <span class="n">hist_mag</span> <span class="o">=</span> <span class="n">mag_log</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])[</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hist_ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

            <span class="n">background</span> <span class="o">=</span> <span class="p">((</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">+</span> <span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">hist_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">EPS</span><span class="p">,</span><span class="n">hist_phase</span><span class="p">[:,:,:,:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="n">hist_phase</span><span class="p">[</span><span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hist_mag</span><span class="p">[</span><span class="n">background</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">prev_outputs2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs2</span><span class="p">]</span>
                <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">4</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gt_masks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">curr_mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">curr_mask</span> <span class="o">=</span> <span class="n">gt_masks</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:]</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_epochs_windowed&#39;</span><span class="p">]:</span>
                <span class="n">random_window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">random_window_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;window_size&#39;</span><span class="p">])</span>
            <span class="n">prev_outputs2</span><span class="p">,</span> <span class="n">prev_outputs1</span><span class="p">,</span> <span class="n">loss_forget_gate_curr</span><span class="p">,</span> <span class="n">loss_input_gate_curr</span><span class="p">,</span> <span class="n">mag_gates_remember</span><span class="p">,</span> <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kspace_m</span><span class="p">(</span>
                                                                                                                                                        <span class="n">hist_mag</span><span class="p">,</span>
                                                                                                                                                        <span class="n">hist_phase</span><span class="p">,</span>
                                                                                                                                                        <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span>
                                                                                                                                                        <span class="n">gt_mask</span> <span class="o">=</span> <span class="n">curr_mask</span><span class="p">,</span>
                                                                                                                                                        <span class="n">mag_prev_outputs</span> <span class="o">=</span> <span class="n">prev_outputs2</span><span class="p">,</span>
                                                                                                                                                        <span class="n">phase_prev_outputs</span> <span class="o">=</span> <span class="n">prev_outputs1</span><span class="p">,</span>
                                                                                                                                                        <span class="n">window_size</span> <span class="o">=</span> <span class="n">random_window_size</span><span class="p">,</span>
                                                                                                                                                        <span class="n">mag_gates_remember</span> <span class="o">=</span> <span class="n">mag_gates_remember</span><span class="p">,</span>
                                                                                                                                                        <span class="n">phase_gates_remember</span> <span class="o">=</span> <span class="n">phase_gates_remember</span><span class="p">,</span>
                                                                                                                                                        <span class="nb">eval</span> <span class="o">=</span> <span class="kc">False</span>
                                                                                                                                                    <span class="p">)</span>
            <span class="n">prev_outputs2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">cycle_mask</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs2</span><span class="p">]</span>
            <span class="n">prev_outputs1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">cycle_mask</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prev_outputs1</span><span class="p">]</span>

            <span class="k">del</span> <span class="n">hist_mag</span>
            <span class="k">del</span> <span class="n">hist_phase</span>
            
            <span class="k">for</span> <span class="n">i_cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">]):</span>
                <span class="n">phase_ti</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">complex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">prev_outputs1</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">prev_outputs1</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]))</span>
                <span class="n">stacked_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">phase_ti</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">phase_ti</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">lstm_predicted_fft</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;logarithm_base&#39;</span><span class="p">]</span><span class="o">**</span><span class="n">prev_outputs2</span><span class="p">[</span><span class="n">i_cell</span><span class="p">])</span><span class="o">*</span><span class="n">phase_ti</span>
                <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">lstm_predicted_fft</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
                <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
                    <span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">numr</span><span class="p">,</span> <span class="n">numc</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">prev_output3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="n">C</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;unet_instead_of_ilstm&#39;</span><span class="p">]:</span>
                        <span class="n">prev_output3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispacem</span><span class="p">(</span><span class="n">predr_ti</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prev_state3</span><span class="p">,</span> <span class="n">prev_output3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispacem</span><span class="p">(</span><span class="n">predr_ti</span><span class="p">,</span> <span class="n">prev_state3</span><span class="p">,</span> <span class="n">prev_output3</span><span class="p">)</span>
                    <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                    <span class="n">predr_ti</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">numr</span><span class="p">,</span> <span class="n">numc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                
                


                <span class="k">if</span> <span class="n">ti</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;init_skip_frames&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">targ_phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="n">loss_mag</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">((</span><span class="n">dists</span><span class="o">*</span><span class="n">prev_outputs2</span><span class="p">[</span><span class="n">i_cell</span><span class="p">]),</span> <span class="n">dists</span><span class="o">*</span><span class="n">cycle_mask</span><span class="o">*</span><span class="p">(</span><span class="n">targ_mag_log</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                        <span class="n">loss_forget_gate</span> <span class="o">+=</span> <span class="n">loss_forget_gate_curr</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                        <span class="n">loss_input_gate</span> <span class="o">+=</span> <span class="n">loss_input_gate_curr</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>

                        <span class="n">targ_angles</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan2</span><span class="p">((</span><span class="n">targ_phase</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">EPS</span><span class="p">,(</span><span class="n">targ_phase</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:,</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                        <span class="n">loss_phase</span> <span class="o">+=</span> <span class="n">criterionL1</span><span class="p">(</span><span class="n">prev_outputs1</span><span class="p">[</span><span class="n">i_cell</span><span class="p">],</span> <span class="n">cycle_mask</span><span class="o">*</span><span class="n">targ_angles</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                        
                        <span class="n">targ_now</span> <span class="o">=</span> <span class="n">targ_real</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:,:]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">prev_output3</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_epochs_recurrent&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_epochs_ilstm&#39;</span><span class="p">]:</span>
                                <span class="n">loss_real</span> <span class="o">+=</span> <span class="mf">1e-10</span><span class="o">*</span><span class="n">criterionL2</span><span class="p">(</span><span class="n">prev_output3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">,</span> <span class="n">targ_now</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">loss_real</span> <span class="o">+=</span> <span class="mi">8</span><span class="o">*</span><span class="n">criterionL2</span><span class="p">(</span><span class="n">prev_output3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">,</span> <span class="n">targ_now</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                        <span class="n">loss_real</span> <span class="o">+=</span> <span class="n">criterionL2</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">,</span> <span class="n">targ_now</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">lossmask</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mag_log</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>
                
                        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                            <span class="n">loss_l1</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predr_ti</span><span class="o">-</span> <span class="n">targ_now</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">]</span>
                            <span class="n">loss_l2</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">predr_ti</span><span class="o">-</span> <span class="n">targ_now</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">]</span>
                            <span class="n">ss1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SSIM</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]),</span> <span class="n">targ_now</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">predr_ti</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_resolution&#39;</span><span class="p">]))</span>
                            <span class="n">ss1</span> <span class="o">=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ss1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">loss_ss1</span> <span class="o">+=</span> <span class="n">ss1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;n_rnn_cells&#39;</span><span class="p">])</span>

            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
                <span class="n">prev_output3</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;image_lstm&#39;</span><span class="p">]:</span>
                <span class="n">predr_kspace</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">predr_ti</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="n">predr</span><span class="p">[:,</span><span class="n">ti</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">prev_output3</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">predr</span> <span class="o">=</span> <span class="n">predr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">predr_mask</span>

        <span class="k">return</span> <span class="n">predr</span><span class="p">,</span> <span class="n">predr_kspace</span><span class="p">,</span> <span class="n">loss_mag</span><span class="p">,</span> <span class="n">loss_phase</span><span class="p">,</span> <span class="n">loss_real</span><span class="p">,</span> <span class="n">loss_forget_gate</span><span class="p">,</span> <span class="n">loss_input_gate</span><span class="p">,</span> <span class="p">(</span><span class="n">loss_l1</span><span class="p">,</span> <span class="n">loss_l2</span><span class="p">,</span> <span class="n">loss_ss1</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CoupledDown">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDown">[docs]</a>
<span class="k">class</span> <span class="nc">CoupledDown</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp_channel</span><span class="p">,</span> <span class="n">outp_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoupledDown</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">inp_channel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp_channels</span><span class="p">:</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">())</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNorm2d</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CoupledDown.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDown.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">no_bn_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoupledDown.train_mode_set">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDown.train_mode_set">[docs]</a>
    <span class="k">def</span> <span class="nf">train_mode_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="nb">bool</span></div>
</div>


<div class="viewcode-block" id="CoupledUp">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUp">[docs]</a>
<span class="k">class</span> <span class="nc">CoupledUp</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp_channel</span><span class="p">,</span> <span class="n">outp_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoupledUp</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">inp_channel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp_channels</span><span class="p">:</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">())</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNorm2d</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">cmplx_upsample</span><span class="o">.</span><span class="n">ComplexUpsample</span><span class="p">(</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CoupledUp.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUp.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">no_bn_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoupledUp.train_mode_set">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUp.train_mode_set">[docs]</a>
    <span class="k">def</span> <span class="nf">train_mode_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="nb">bool</span></div>
</div>


<div class="viewcode-block" id="CoupledDownReal">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDownReal">[docs]</a>
<span class="k">class</span> <span class="nc">CoupledDownReal</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp_channel</span><span class="p">,</span> <span class="n">outp_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoupledDownReal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">inp_channel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp_channels</span><span class="p">:</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="c1"># self.final = nn.Sequential(</span>
        <span class="c1">#                                     nn.Conv2d(prev, prev, (2,2), stride = (2,2), padding = (0,0)),</span>
        <span class="c1">#                                     nn.ReLU(),</span>
        <span class="c1">#                                     nn.BatchNorm2d(prev)</span>
        <span class="c1">#                             )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CoupledDownReal.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDownReal.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">no_bn_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoupledDownReal.train_mode_set">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledDownReal.train_mode_set">[docs]</a>
    <span class="k">def</span> <span class="nf">train_mode_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="nb">bool</span></div>
</div>


<div class="viewcode-block" id="CoupledUpReal">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUpReal">[docs]</a>
<span class="k">class</span> <span class="nc">CoupledUpReal</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp_channel</span><span class="p">,</span> <span class="n">outp_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoupledUpReal</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">inp_channel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp_channels</span><span class="p">:</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">ls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Upsample</span><span class="p">(</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CoupledUpReal.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUpReal.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">no_bn_forward</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoupledUpReal.train_mode_set">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.CoupledUpReal.train_mode_set">[docs]</a>
    <span class="k">def</span> <span class="nf">train_mode_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_mode</span> <span class="o">=</span> <span class="nb">bool</span></div>
</div>


<div class="viewcode-block" id="ImageSpaceModel1">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.ImageSpaceModel1">[docs]</a>
<span class="k">class</span> <span class="nc">ImageSpaceModel1</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">proc_device</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ImageSpaceModel1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;final_prediction_real&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;coil_combine&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SOS&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_dic</span><span class="p">[</span><span class="s1">&#39;num_coils&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_prediction_real</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down1</span> <span class="o">=</span> <span class="n">CoupledDownReal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_size</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down2</span> <span class="o">=</span> <span class="n">CoupledDownReal</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down3</span> <span class="o">=</span> <span class="n">CoupledDownReal</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">CoupledUpReal</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">CoupledUpReal</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">64</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">CoupledUpReal</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">32</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalblock</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConvd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">(),</span>
                    <span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNormd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">),</span>
                    <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConvd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">(),</span>
                    <span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNormd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down1</span> <span class="o">=</span> <span class="n">CoupledDown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_coils</span><span class="p">,</span> <span class="p">[</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down2</span> <span class="o">=</span> <span class="n">CoupledDown</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">64</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">down3</span> <span class="o">=</span> <span class="n">CoupledDown</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up1</span> <span class="o">=</span> <span class="n">CoupledUp</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span><span class="mi">128</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up2</span> <span class="o">=</span> <span class="n">CoupledUp</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span><span class="mi">64</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">up3</span> <span class="o">=</span> <span class="n">CoupledUp</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">32</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalblock</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">(),</span>
                    <span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                    <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                    <span class="n">cmplx_activation</span><span class="o">.</span><span class="n">CReLU</span><span class="p">(),</span>
                    <span class="n">radial_bn</span><span class="o">.</span><span class="n">RadialBatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
                    <span class="n">cmplx_conv</span><span class="o">.</span><span class="n">ComplexConv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>     <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">stride</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                <span class="p">)</span>

<div class="viewcode-block" id="ImageSpaceModel1.time_analysis">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.ImageSpaceModel1.time_analysis">[docs]</a>
    <span class="k">def</span> <span class="nf">time_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x2hat</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">x3hat</span><span class="p">,</span> <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
            <span class="n">x4hat</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
            <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
            <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x5</span><span class="p">,</span><span class="n">x4hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">x7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x6</span><span class="p">,</span><span class="n">x3hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">x8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalblock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x7</span><span class="p">,</span><span class="n">x2hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span></div>


<div class="viewcode-block" id="ImageSpaceModel1.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.ImageSpaceModel1.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">x</span>
        <span class="n">x2hat</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down1</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">x3hat</span><span class="p">,</span> <span class="n">x3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down2</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
        <span class="n">x4hat</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">down3</span><span class="p">(</span><span class="n">x3</span><span class="p">)</span>
        <span class="n">x5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up1</span><span class="p">(</span><span class="n">x4</span><span class="p">)</span>
        <span class="n">x6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up2</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x5</span><span class="p">,</span><span class="n">x4hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x7</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">up3</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x6</span><span class="p">,</span><span class="n">x3hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">x8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalblock</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x7</span><span class="p">,</span><span class="n">x2hat</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x8</span></div>
</div>






<div class="viewcode-block" id="UNet">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.UNet">[docs]</a>
<span class="k">class</span> <span class="nc">UNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upconv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upconv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">final_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="UNet.forward">
<a class="viewcode-back" href="../periodLSTM.html#periodLSTM.UNet.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Encoder</span>
        <span class="n">enc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">enc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool1</span><span class="p">(</span><span class="n">enc1</span><span class="p">))</span>

        <span class="c1"># Bottleneck</span>
        <span class="n">bottleneck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottleneck</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool2</span><span class="p">(</span><span class="n">enc2</span><span class="p">))</span>

        <span class="c1"># Decoder</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upconv2</span><span class="p">(</span><span class="n">bottleneck</span><span class="p">)</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dec2</span><span class="p">,</span> <span class="n">enc2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder2</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span>

        <span class="n">dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upconv1</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dec1</span><span class="p">,</span> <span class="n">enc1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder1</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_conv</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span></div>
</div>

</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, AERS + NRM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>